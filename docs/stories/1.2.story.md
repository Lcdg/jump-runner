# Story 1.2: Game Loop & Canvas Rendering

## Status

Ready for Review

## Story

**As a** developer,
**I want** a stable game loop running at 60 FPS with delta time,
**so that** the game runs smoothly and consistently across different machines.

## Acceptance Criteria

1. Game loop utilisant `requestAnimationFrame`
2. Delta time calculé entre chaque frame pour des mouvements frame-independent
3. Canvas redimensionné automatiquement à la taille de la fenêtre
4. Fond de couleur unie rendu à chaque frame (preuve que le rendering fonctionne)
5. FPS counter affiché en mode développement (optionnel, peut être désactivé)
6. Tests unitaires vérifiant le calcul du delta time
7. Architecture modulaire : séparation `Game.ts`, `Renderer.ts`

## Tasks / Subtasks

- [x] **Task 1: Create Renderer class** (AC: 3, 4)
  - [x] Créer `src/rendering/Renderer.ts`
  - [x] Implémenter le constructeur avec récupération du canvas et contexte 2D
  - [x] Implémenter `handleResize()` pour redimensionner le canvas à la taille de la fenêtre
  - [x] Ajouter event listener sur `window.resize`
  - [x] Implémenter `clear()` pour effacer le canvas avec couleur de fond
  - [x] Implémenter getters : `getContext()`, `getWidth()`, `getHeight()`, `getGroundY()`

- [x] **Task 2: Create Game class with game loop** (AC: 1, 2, 7)
  - [x] Créer `src/core/Game.ts`
  - [x] Implémenter le constructeur qui initialise le Renderer
  - [x] Implémenter `start()` qui démarre le game loop
  - [x] Implémenter `gameLoop(currentTime)` avec `requestAnimationFrame`
  - [x] Calculer le delta time : `deltaTime = (currentTime - lastTime) / 1000`
  - [x] Stocker `lastTime` pour le prochain frame
  - [x] Appeler `update(deltaTime)` et `render()` à chaque frame

- [x] **Task 3: Implement update and render methods** (AC: 4)
  - [x] Implémenter `update(deltaTime: number)` (vide pour l'instant)
  - [x] Implémenter `render()` qui appelle `renderer.clear()`
  - [x] Vérifier que le fond de couleur s'affiche correctement

- [x] **Task 4: Add FPS counter (dev mode)** (AC: 5)
  - [x] Ajouter constante `DEBUG.SHOW_FPS` dans `constants.ts`
  - [x] Calculer FPS avec lissage (moyenne sur 1 seconde)
  - [x] Afficher FPS en haut à gauche du canvas si `DEBUG.SHOW_FPS` est true
  - [x] Utiliser un lissage (moyenne sur les derniers frames) pour éviter le clignotement

- [x] **Task 5: Update main.ts entry point**
  - [x] Modifier `src/main.ts` pour utiliser la classe Game
  - [x] Instancier Game et appeler `start()`
  - [x] Supprimer l'ancien code de game loop basique

- [x] **Task 6: Write unit tests** (AC: 6)
  - [x] Créer `tests/unit/core/Game.test.ts`
  - [x] Tester le calcul du delta time
  - [x] Tester que le delta time est en secondes (pas en millisecondes)
  - [x] Créer `tests/unit/rendering/Renderer.test.ts`
  - [x] Tester `getGroundY()` retourne un pourcentage de la hauteur

- [x] **Task 7: Validation et cleanup**
  - [x] `npm run lint` passe sans erreur
  - [x] `npm run test:run` passe (14 tests)
  - [x] `npm run build` passe
  - [x] Le redimensionnement de la fenêtre fonctionne
  - [x] FPS counter s'affiche (si activé)

## Dev Notes

### Previous Story Context
[Source: Story 1.1 Dev Agent Record]

**Fichiers existants créés dans Story 1.1:**
- `src/main.ts` - Entry point actuel (à modifier)
- `src/config/constants.ts` - Constantes de jeu (à enrichir)
- `src/core/types.ts` - Interfaces TypeScript

### Renderer Class Implementation
[Source: architecture/rendering-architecture.md]

```typescript
// src/rendering/Renderer.ts
export class Renderer {
  private canvas: HTMLCanvasElement;
  private ctx: CanvasRenderingContext2D;
  private width: number = 0;
  private height: number = 0;

  constructor(canvasId: string) {
    this.canvas = document.getElementById(canvasId) as HTMLCanvasElement;
    this.ctx = this.canvas.getContext('2d')!;
    this.handleResize();
    window.addEventListener('resize', () => this.handleResize());
  }

  private handleResize(): void {
    this.width = window.innerWidth;
    this.height = window.innerHeight;
    this.canvas.width = this.width;
    this.canvas.height = this.height;
  }

  clear(): void {
    this.ctx.fillStyle = COLORS.SKY;
    this.ctx.fillRect(0, 0, this.width, this.height);
  }

  getContext(): CanvasRenderingContext2D { return this.ctx; }
  getWidth(): number { return this.width; }
  getHeight(): number { return this.height; }
  getGroundY(): number {
    return Math.floor(this.height * CANVAS.GROUND_Y_PERCENT);
  }
}
```

### Game Loop Pattern
[Source: architecture/tech-stack.md]

```typescript
// src/core/Game.ts
export class Game {
  private renderer: Renderer;
  private lastTime: number = 0;
  private isRunning: boolean = false;

  constructor() {
    this.renderer = new Renderer('game');
  }

  start(): void {
    this.isRunning = true;
    this.lastTime = performance.now();
    requestAnimationFrame((time) => this.gameLoop(time));
  }

  private gameLoop(currentTime: number): void {
    if (!this.isRunning) return;

    const deltaTime = (currentTime - this.lastTime) / 1000; // en secondes
    this.lastTime = currentTime;

    this.update(deltaTime);
    this.render();

    requestAnimationFrame((time) => this.gameLoop(time));
  }

  private update(deltaTime: number): void {
    // Game logic here
  }

  private render(): void {
    this.renderer.clear();
    // Render game objects here
  }
}
```

### Constants to Add
[Source: architecture/game-configuration-constants.md]

```typescript
// À ajouter dans src/config/constants.ts

export const COLORS = {
  SKY: '#1a1a2e',
  GROUND: '#16213e',
} as const;

export const CANVAS = {
  GROUND_Y_PERCENT: 0.8, // Sol à 80% de la hauteur
  PLAYER_X_PERCENT: 0.15, // Joueur à 15% de la largeur
} as const;

export const DEBUG = {
  SHOW_FPS: true, // Afficher le compteur FPS en dev
} as const;
```

### Project Structure After This Story
[Source: architecture/project-structure.md]

```
src/
├── main.ts                 # Entry point (modified)
├── config/
│   └── constants.ts        # Game constants (enriched)
├── core/
│   ├── Game.ts             # NEW - Main game class
│   └── types.ts            # TypeScript interfaces
└── rendering/
    └── Renderer.ts         # NEW - Canvas renderer
```

## Testing

### Test Standards
[Source: architecture/testing-strategy.md]

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/` |

### Tests to Create

**Game.test.ts** (`tests/unit/core/Game.test.ts`):
```typescript
import { describe, it, expect, vi } from 'vitest';

describe('Game', () => {
  describe('deltaTime calculation', () => {
    it('should calculate deltaTime in seconds', () => {
      // Mock performance.now
      const times = [0, 16.67]; // ~60 FPS
      let callCount = 0;
      vi.spyOn(performance, 'now').mockImplementation(() => times[callCount++]);

      // deltaTime should be approximately 0.01667 seconds
      const deltaTime = (times[1] - times[0]) / 1000;
      expect(deltaTime).toBeCloseTo(0.01667, 4);
    });

    it('should handle variable frame times', () => {
      const deltaTime = (33.33 - 0) / 1000; // 30 FPS
      expect(deltaTime).toBeCloseTo(0.03333, 4);
    });
  });
});
```

**Renderer.test.ts** (`tests/unit/rendering/Renderer.test.ts`):
```typescript
import { describe, it, expect } from 'vitest';
import { CANVAS } from '../../../src/config/constants';

describe('Renderer calculations', () => {
  it('should calculate ground Y as percentage of height', () => {
    const height = 1080;
    const groundY = Math.floor(height * CANVAS.GROUND_Y_PERCENT);
    expect(groundY).toBe(864); // 80% of 1080
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée | PO Agent (Sarah) |
| 2025-01-17 | 1.1 | Implémentation complète - Ready for Review | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Ajout de `performance` aux globales ESLint pour corriger l'erreur no-undef

### Completion Notes List
- Game loop avec requestAnimationFrame et delta time en secondes
- FPS counter avec lissage sur 1 seconde
- Architecture modulaire : Game.ts et Renderer.ts séparés
- 14 tests unitaires passent

### File List
**Fichiers créés:**
- `src/core/Game.ts` - Classe principale avec game loop
- `src/rendering/Renderer.ts` - Gestion du canvas et rendu
- `tests/unit/core/Game.test.ts` - Tests du game loop et delta time
- `tests/unit/rendering/Renderer.test.ts` - Tests des calculs Renderer

**Fichiers modifiés:**
- `src/main.ts` - Utilise maintenant la classe Game
- `src/config/constants.ts` - Ajout COLORS, DEBUG, CANVAS.GROUND_Y_PERCENT
- `eslint.config.js` - Ajout de `performance` aux globales

---

## QA Results
*(À compléter par le QA Agent)*
