# Story 1.4: Variable Jump Height

## Status

Done

## Story

**As a** player,
**I want** the jump height to vary based on how long I hold the Space key,
**so that** I have more control and skill expression.

## Acceptance Criteria

1. Appui court sur Espace = petit saut
2. Appui prolongé sur Espace = saut plus haut (jusqu'à un maximum)
3. Relâcher la touche coupe la montée (le personnage commence à redescendre)
4. Hauteur maximale plafonnée même si on maintient indéfiniment
5. La transition entre petit et grand saut est fluide (pas de "paliers")
6. Tests unitaires vérifiant les différentes hauteurs selon la durée de pression
7. Test E2E : comparaison visuelle ou d'état entre appui court et appui long

## Tasks / Subtasks

- [x] **Task 1: Modifier Player pour supporter le saut variable** (AC: 1, 2, 3, 4, 5)
  - [x] Ajouter propriété `jumpHoldTime: number` pour tracker la durée de maintien
  - [x] Ajouter propriété `isHoldingJump: boolean` pour savoir si la touche est maintenue
  - [x] Modifier `jump()` pour initialiser le saut avec vélocité initiale minimale
  - [x] Créer méthode `holdJump(deltaTime)` pour augmenter la vélocité pendant le maintien
  - [x] Créer méthode `releaseJump()` pour arrêter l'augmentation de vélocité
  - [x] Plafonner la durée de maintien à `MAX_JUMP_HOLD_TIME`

- [x] **Task 2: Ajouter constantes pour le saut variable** (AC: 1, 2, 4)
  - [x] `PHYSICS.MIN_JUMP_VELOCITY`: vélocité pour appui court (-400)
  - [x] `PHYSICS.MAX_JUMP_VELOCITY`: vélocité max pour appui long (-700)
  - [x] `PHYSICS.JUMP_HOLD_FORCE`: force additionnelle par seconde de maintien (2800)
  - [x] Ajuster `MAX_JUMP_HOLD_TIME` (180ms)

- [x] **Task 3: Modifier Game.ts pour gérer jump_end** (AC: 3)
  - [x] Sur `jump_start`: appeler `player.jump()`
  - [x] Dans `update()`: si touche maintenue et player en jumping, appeler `player.holdJump(deltaTime)`
  - [x] Sur `jump_end`: appeler `player.releaseJump()`
  - [x] Utiliser `InputManager.isJumpHeld()` pour détecter le maintien

- [x] **Task 4: Implémenter la mécanique de saut variable dans Player.update()** (AC: 5)
  - [x] Si `isHoldingJump` et `state === 'jumping'` et `jumpHoldTime < MAX_JUMP_HOLD_TIME`:
    - Ajouter force vers le haut (réduire velocity.y)
    - Incrémenter `jumpHoldTime`
  - [x] Sinon: appliquer uniquement la gravité normale
  - [x] Transition fluide: utiliser force constante

- [x] **Task 5: Écrire tests unitaires** (AC: 6)
  - [x] Modifier `tests/unit/entities/Player.test.ts`
  - [x] Test: appui court = hauteur basse (simuler release immédiat)
  - [x] Test: appui long = hauteur plus élevée (simuler holdJump sur plusieurs frames)
  - [x] Test: hauteur plafonnée après MAX_JUMP_HOLD_TIME
  - [x] Test: releaseJump() arrête l'augmentation de vélocité

- [x] **Task 6: Écrire test E2E** (AC: 7)
  - [x] Créer `tests/e2e/variable-jump.spec.ts`
  - [x] Tests pour appui court, appui long, release mid-jump
  - [x] Tests pour mouse click hold
  - [x] Note: Tests E2E créés mais non exécutables en WSL (dépendance système manquante)

- [x] **Task 7: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (49 tests)
  - [ ] `npm run test:e2e` - Bloqué par environnement WSL (libnspr4.so manquante)
  - [ ] Test manuel: à effectuer par l'utilisateur

## Dev Notes

### Previous Story Context
[Source: Story 1.3]

**Code existant pertinent:**

1. **Player.ts** (`src/entities/Player.ts`):
   - États: `idle`, `jumping`, `falling`
   - Méthode `jump()` applique `PHYSICS.JUMP_VELOCITY` fixe
   - Méthode `update(deltaTime)` applique la gravité
   - Transition jumping → falling quand `velocity.y > 0`

2. **InputManager.ts** (`src/input/InputManager.ts`):
   - Émet déjà `jump_start` et `jump_end`
   - Méthode `isJumpHeld()` retourne si la touche est maintenue
   - Gère clavier (Space) et souris (clic gauche)

3. **constants.ts** (`src/config/constants.ts`):
   - `PHYSICS.GRAVITY: 1800`
   - `PHYSICS.JUMP_VELOCITY: -650`
   - `PHYSICS.MAX_JUMP_HOLD_TIME: 150` (déjà présent!)

### Approche Technique Recommandée

**Option A - Force continue pendant le maintien (recommandée):**
```typescript
// Dans Player.ts
holdJump(deltaTime: number): void {
  if (this.state === 'jumping' && this.isHoldingJump) {
    if (this.jumpHoldTime < PHYSICS.MAX_JUMP_HOLD_TIME) {
      // Ajouter force vers le haut (contre la gravité)
      this.velocity.y -= PHYSICS.JUMP_HOLD_FORCE * deltaTime;
      this.jumpHoldTime += deltaTime * 1000; // convertir en ms

      // Plafonner la vélocité max
      if (this.velocity.y < PHYSICS.MAX_JUMP_VELOCITY) {
        this.velocity.y = PHYSICS.MAX_JUMP_VELOCITY;
      }
    }
  }
}

releaseJump(): void {
  this.isHoldingJump = false;
}
```

**Option B - Vélocité initiale variable:**
```typescript
// Calculer vélocité en fonction du temps de maintien à la release
// Plus complexe car nécessite de prédire ou attendre
```

### Constantes Suggérées

```typescript
export const PHYSICS = {
  GRAVITY: 1800,
  MIN_JUMP_VELOCITY: -400,      // Appui court
  MAX_JUMP_VELOCITY: -750,      // Appui long max
  JUMP_HOLD_FORCE: 2500,        // Force par seconde de maintien
  MAX_JUMP_HOLD_TIME: 180,      // ms max de maintien effectif
} as const;
```

### Structure des Fichiers Modifiés

```
src/
├── config/constants.ts      # MODIFIED - nouvelles constantes PHYSICS
├── core/Game.ts             # MODIFIED - gérer holdJump dans update
└── entities/Player.ts       # MODIFIED - holdJump(), releaseJump()
```

## Testing

### Test Standards
[Source: architecture/testing-strategy.md]

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/` |
| E2E | Playwright | `tests/e2e/` |

### Unit Tests

**Player.test.ts** - Nouveaux tests à ajouter:
```typescript
describe('Variable Jump', () => {
  it('should have lower max height with short press', () => {
    const player = new Player(groundY);
    player.jump();
    player.releaseJump(); // Relâcher immédiatement

    // Simuler plusieurs frames jusqu'à l'apogée
    let maxHeight = player.getPosition().y;
    for (let i = 0; i < 60; i++) {
      player.update(1/60);
      if (player.getPosition().y < maxHeight) {
        maxHeight = player.getPosition().y;
      }
    }

    expect(maxHeight).toBeGreaterThan(someThreshold); // Plus proche du sol
  });

  it('should have higher max height with long press', () => {
    const player = new Player(groundY);
    player.jump();

    // Simuler maintien pendant 150ms (9 frames à 60fps)
    for (let i = 0; i < 9; i++) {
      player.holdJump(1/60);
      player.update(1/60);
    }
    player.releaseJump();

    // Continuer jusqu'à l'apogée...
  });

  it('should cap jump height after MAX_JUMP_HOLD_TIME', () => {
    // Vérifier que maintenir plus longtemps ne change rien
  });
});
```

### E2E Test

**variable-jump.spec.ts**:
```typescript
import { test, expect } from '@playwright/test';

test('short press results in lower jump than long press', async ({ page }) => {
  await page.goto('/');
  await page.waitForTimeout(500); // Laisser le jeu charger

  // Test appui court
  await page.keyboard.down('Space');
  await page.waitForTimeout(50);
  await page.keyboard.up('Space');

  // Attendre que le joueur retombe
  await page.waitForTimeout(1000);

  // TODO: Capturer hauteur max (via exposed state ou screenshot)

  // Test appui long
  await page.keyboard.down('Space');
  await page.waitForTimeout(300);
  await page.keyboard.up('Space');

  // Vérifier différence de hauteur
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée | PO Agent (Sarah) |
| 2025-01-17 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - Pas de problèmes majeurs rencontrés

### Completion Notes List
- Implémentation de la mécanique de saut variable avec force continue pendant le maintien
- Les constantes PHYSICS ont été mises à jour avec MIN/MAX_JUMP_VELOCITY et JUMP_HOLD_FORCE
- Game.ts appelle maintenant `holdJump()` si la touche est maintenue, et `releaseJump()` sur jump_end
- 7 nouveaux tests unitaires ajoutés pour valider le saut variable
- 5 tests E2E créés pour valider les interactions (non exécutables en WSL - dépendance système manquante)
- Tests unitaires: 49 passent
- Build production: OK

### File List
**Modified:**
- `src/config/constants.ts` - Nouvelles constantes PHYSICS (MIN/MAX_JUMP_VELOCITY, JUMP_HOLD_FORCE)
- `src/entities/Player.ts` - Ajout jumpHoldTime, isHoldingJump, holdJump(), releaseJump(), isJumpHeld()
- `src/core/Game.ts` - Gestion de holdJump dans update() et releaseJump() dans handleInput()
- `tests/unit/entities/Player.test.ts` - 7 nouveaux tests pour le saut variable

**Created:**
- `tests/e2e/variable-jump.spec.ts` - 5 tests E2E pour le saut variable

---

## QA Results
*(À compléter par le QA Agent)*
