# Story 6.1: Système de Skins (Architecture)

## Status

Ready for Review

## Story

**As a** developer,
**I want** a modular skin architecture,
**so that** multiple character designs can coexist and be swapped at runtime.

## Acceptance Criteria

1. Interface `PlayerSkin` définissant le contrat de rendu (render idle, run, jump, fall, land)
2. Classe `ClassicSkin` encapsulant le rendu actuel (rectangle + cercle + jambes)
3. Le `Game` utilise le skin actif via l'interface au lieu du rendu en dur dans `renderPlayer()`
4. Le jeu fonctionne exactement comme avant avec le `ClassicSkin` (aucune régression visuelle)
5. Factory ou registre de skins pour ajouter de nouveaux skins facilement
6. Tests unitaires vérifiant que le ClassicSkin est appelé correctement
7. `npm run lint` passe
8. `npm run test:run` passe
9. `npm run build` passe

## Tasks / Subtasks

- [x] **Task 1: Créer l'interface PlayerSkin** (AC: 1)
  - [x] Créer `src/skins/PlayerSkin.ts` avec l'interface
  - [x] Définir les méthodes : `init()`, `render()`, `getName()`, `getThumbnail()`
  - [x] Définir le type `AnimationData` (state, phase, squashFactor, velocity)

- [x] **Task 2: Créer le SkinManager** (AC: 5)
  - [x] Créer `src/skins/SkinManager.ts`
  - [x] Méthodes : `register(skin)`, `setActive(name)`, `getActive()`, `getAll()`
  - [x] Stockage du skin actif (préparation localStorage pour Story 6.4)

- [x] **Task 3: Extraire ClassicSkin depuis Game.ts** (AC: 2, 3, 4)
  - [x] Créer `src/skins/ClassicSkin.ts`
  - [x] Déplacer tout le code de `renderPlayer()` (Game.ts:848-925) dans `ClassicSkin.render()`
  - [x] Inclure le rendu normal ET le rendu squash
  - [x] Inclure l'animation des jambes et le flash de collision
  - [x] Remplacer `renderPlayer()` dans Game.ts par un appel au skin actif

- [x] **Task 4: Intégrer SkinManager dans Game** (AC: 3, 4)
  - [x] Ajouter `SkinManager` comme dépendance de `Game`
  - [x] Enregistrer `ClassicSkin` comme skin par défaut
  - [x] Modifier `renderPlayer()` pour déléguer au skin actif
  - [x] Passer les données nécessaires (ctx, position, state, animationData)

- [x] **Task 5: Tests et Validation** (AC: 6, 7, 8, 9)
  - [x] Tests unitaires PlayerSkin interface (mock)
  - [x] Tests unitaires SkinManager (register, setActive, getActive)
  - [x] Tests unitaires ClassicSkin (appel render avec bons paramètres)
  - [x] Vérifier aucune régression visuelle (jeu identique)
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe
  - [x] `npm run build` passe

## Dev Notes

### Code actuel à extraire

Le rendu du personnage est entièrement dans `Game.ts:848-925` (`renderPlayer()`). Il gère :
- **Mode normal** (lignes 904-924) : tête (arc), corps (fillRect), jambes animées (fillRect + legOffset)
- **Mode squash** (lignes 867-903) : même éléments mais avec facteurs de scale appliqués, ancré aux pieds
- **Flash collision** : couleur override via `this.isColliding`

### Données nécessaires pour le rendu

Le skin a besoin de ces données depuis Player/Game :
- `position: { x, y }` — position du personnage
- `state: PlayerState` — 'idle' | 'jumping' | 'falling' | 'landing'
- `runAnimationPhase: number` — phase 0-1 du cycle de course
- `squashFactor: { scaleX, scaleY }` — compression à l'atterrissage
- `isColliding: boolean` — flash blanc en cas de collision
- `groundY: number` — position Y du sol (pour ancrage squash)

### Constantes existantes (constants.ts)

```typescript
PLAYER = {
  WIDTH: 40, HEIGHT: 60, HEAD_RADIUS: 15,
  HITBOX_OFFSET_X: 5, HITBOX_OFFSET_Y: 0, HITBOX_WIDTH: 30, HITBOX_HEIGHT: 60,
  LEG_WIDTH: 6, LEG_HEIGHT: 20, LEG_GAP: 8, LEG_AMPLITUDE: 6,
  RUN_CYCLE_DURATION: 0.2, SQUASH_DURATION: 0.05,
  SQUASH_SCALE_Y: 0.8, SQUASH_SCALE_X: 1.2,
}

COLORS = {
  PLAYER_BODY: '#FF6B35',
  PLAYER_HEAD: '#FF8C42',
}
```

### Structure de fichiers à créer

```
src/skins/
├── PlayerSkin.ts       # Interface + types
├── SkinManager.ts      # Registre de skins
└── ClassicSkin.ts      # Rendu actuel extrait
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/skins/PlayerSkin.test.ts |
| Unit | Vitest | tests/unit/skins/SkinManager.test.ts |
| Unit | Vitest | tests/unit/skins/ClassicSkin.test.ts |

### Standards de test
- Vitest avec `vi.fn()` pour les mocks
- Tests dans `tests/unit/skins/`
- Naming: `describe('ClassicSkin')` → `it('should render head as arc')`
- Mocker le CanvasRenderingContext2D pour vérifier les appels de rendu

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Extracted `renderPlayer()` from Game.ts into a modular skin system
- ClassicSkin reproduces the exact same rendering logic (normal + squash modes, leg animation, collision flash)
- SkinManager acts as a registry with first-registered-is-default behavior
- Game.ts `renderPlayer()` reduced from 77 lines to 11 lines — now delegates to active skin
- AnimationData type bundles all rendering state needed by any skin implementation
- 24 new tests added, 273 total passing, 0 regressions

### File List

| File | Action |
|------|--------|
| `src/skins/PlayerSkin.ts` | Created — Interface + AnimationData types |
| `src/skins/SkinManager.ts` | Created — Skin registry |
| `src/skins/ClassicSkin.ts` | Created — Original geometric rendering |
| `src/core/Game.ts` | Modified — Added SkinManager, replaced renderPlayer() |
| `tests/unit/skins/SkinManager.test.ts` | Created — 12 tests |
| `tests/unit/skins/ClassicSkin.test.ts` | Created — 12 tests |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
| 2026-02-01 | 1.1 | Implementation complete | Dev Agent (James) |
