# Story 3.2: Attract Mode with Auto-Play

## Status

Done

## Story

**As a** player,
**I want** to see the game playing itself on the title screen,
**so that** I understand the gameplay before starting.

## Acceptance Criteria

1. En AttractMode, le décor défile et les obstacles apparaissent normalement
2. Un personnage "IA" saute automatiquement pour éviter les obstacles
3. L'IA n'est pas parfaite : logique simple (sauter quand obstacle proche)
4. Overlay "Press Space to Start" affiché au centre de l'écran
5. Appuyer sur Espace transitionne vers Playing
6. Pas de score affiché en AttractMode
7. Tests unitaires pour la logique d'auto-jump de l'IA
8. Test E2E : vérifier que l'attract mode tourne et que Space lance le jeu

## Tasks / Subtasks

- [x] **Task 1: Créer le système AutoPlayer** (AC: 2, 3)
  - [x] Créer `src/systems/AutoPlayerSystem.ts`
  - [x] Fonction `shouldJump(playerX, playerY, obstacles): boolean`
  - [x] Logique simple: sauter quand obstacle à distance < seuil
  - [x] Ajouter un peu d'imperfection (délai réaction, échecs occasionnels)

- [x] **Task 2: Intégrer AutoPlayer dans Game.ts** (AC: 1, 2)
  - [x] Importer AutoPlayerSystem
  - [x] Dans update() en attract: appeler shouldJump et faire sauter le player
  - [x] Le player doit être contrôlable par l'IA en attract

- [x] **Task 3: Activer le player en attract** (AC: 1, 2)
  - [x] Modifier resetGameplay pour activer le player
  - [x] S'assurer que player.update() est appelé en attract
  - [x] S'assurer que le player peut sauter en attract

- [x] **Task 4: Afficher overlay "Press Space to Start"** (AC: 4)
  - [x] Créer méthode renderAttractOverlay() dans Game.ts
  - [x] Afficher texte centré "Press Space to Start"
  - [x] Style: police lisible, contraste avec le fond
  - [x] Appeler uniquement en état attract

- [x] **Task 5: Vérifier transitions** (AC: 5, 6)
  - [x] S'assurer que Space en attract → playing fonctionne (déjà fait en 3.1)
  - [x] Vérifier qu'aucun score n'est affiché en attract

- [x] **Task 6: Écrire tests unitaires AutoPlayerSystem** (AC: 7)
  - [x] Test: shouldJump retourne true quand obstacle proche
  - [x] Test: shouldJump retourne false quand obstacle loin
  - [x] Test: shouldJump retourne false quand pas d'obstacle
  - [x] Test: shouldJump considère la position Y du player

- [x] **Task 7: Écrire tests intégration** (AC: 2, 8)
  - [x] Test: en attract, le player saute automatiquement
  - [x] Test: overlay visible en attract

- [x] **Task 8: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (177 tests)
  - [x] `npm run build` passe
  - [x] Test manuel: vérifier l'attract mode visuellement

## Dev Notes

### Previous Story Context
[Source: Story 3.1]

**Code existant pertinent:**

1. **GameStateManager.ts** - États et transitions:
```typescript
private currentState: GameStateType = 'attract';
transition(to: GameStateType): boolean
```

2. **Game.ts** - Update par état (ligne 191-216):
```typescript
if (currentState === 'attract') {
  // In attract: obstacles spawn and move, but player is static
  this.updateObstacles(deltaTime);
}
```

3. **Player.ts** - Contrôles de saut:
```typescript
jump(): void
update(deltaTime: number): void
```

### Architecture Technique

**AutoPlayerSystem** - Fonction pure stateless:
```typescript
export interface AutoPlayerInput {
  playerX: number;
  playerY: number;
  playerWidth: number;
  playerHeight: number;
  groundY: number;
  obstacles: Array<{ x: number; y: number; width: number; height: number }>;
}

export function shouldAutoJump(input: AutoPlayerInput): boolean {
  // Trouver l'obstacle le plus proche devant le player
  const nearestObstacle = findNearestObstacleAhead(input);
  if (!nearestObstacle) return false;

  // Calculer distance et décider
  const distance = nearestObstacle.x - (input.playerX + input.playerWidth);
  const jumpThreshold = 150; // pixels

  return distance > 0 && distance < jumpThreshold && input.playerY >= input.groundY - playerHeight;
}
```

### Constants à ajouter
```typescript
export const AUTO_PLAYER = {
  JUMP_THRESHOLD: 150,    // Distance pour déclencher le saut
  REACTION_DELAY: 0.05,   // Délai de réaction (secondes)
  MISS_CHANCE: 0.05,      // 5% de chance de rater
} as const;
```

### File Locations

| Nouveau fichier | Location |
|-----------------|----------|
| AutoPlayerSystem | `src/systems/AutoPlayerSystem.ts` |
| Tests unitaires | `tests/unit/systems/AutoPlayerSystem.test.ts` |

| Fichier à modifier | Modifications |
|--------------------|---------------|
| `src/core/Game.ts` | Intégrer AutoPlayer en attract, renderAttractOverlay() |
| `src/config/constants.ts` | Ajouter AUTO_PLAYER constants |

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/systems/AutoPlayerSystem.test.ts` |
| Integration | Vitest | `tests/unit/core/Game.attract.test.ts` |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 1.0 | Story créée | Dev Agent (James) |
| 2026-01-18 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A

### Completion Notes List
- AutoPlayerSystem créé avec logique simple de détection d'obstacle
- shouldAutoJump vérifie: obstacle proche, player au sol, chance d'échec
- MISS_CHANCE de 2% pour imperfection réaliste
- Intégration dans Game.ts via updateAutoPlayer()
- Player mis à jour en attract (player.update() appelé)
- Overlay "Press Space to Start" avec ombre pour lisibilité
- Constantes UI et AUTO_PLAYER ajoutées
- 14 tests AutoPlayerSystem + 9 tests Game.attract
- Total: 177 tests passent

### File List
**Created:**
- `src/systems/AutoPlayerSystem.ts` - IA simple pour attract mode
- `tests/unit/systems/AutoPlayerSystem.test.ts` - 14 tests
- `tests/unit/core/Game.attract.test.ts` - 9 tests

**Modified:**
- `src/core/Game.ts` - updateAutoPlayer(), renderAttractOverlay(), imports
- `src/config/constants.ts` - AUTO_PLAYER, UI constants

---

## QA Results
*(À compléter par le QA Agent)*
