# Story 6.2: Sprite Sheet du Personnage (Design Détaillé)

## Status

Ready for Review

## Story

**As a** player,
**I want** a detailed, realistic-looking character,
**so that** the game has a polished, professional visual quality.

## Acceptance Criteria

1. Sprite sheets créées pour le personnage avec les frames suivantes :
   - **Idle** : 1-2 frames (personnage debout, léger mouvement)
   - **Course** : 6-8 frames (cycle de course complet)
   - **Saut montée** : 2-3 frames (impulsion → position aérienne)
   - **Chute** : 1-2 frames (bras/jambes en position de descente)
   - **Atterrissage** : 2-3 frames (flexion → recovery)
2. Système de chargement de sprite sheet (`SpriteSheet` class) avec découpage automatique des frames
3. Classe `DetailedSkin` implémentant `PlayerSkin` avec rendu par sprites
4. Le personnage est clairement identifiable comme un humain (proportions, couleurs, vêtements)
5. Les sprites respectent les dimensions de la hitbox existante (~40x60px zone de jeu)
6. Performance : `drawImage()` maintient 60 FPS constant
7. Tests unitaires pour le chargement et le découpage des sprites
8. `npm run lint` passe
9. `npm run test:run` passe
10. `npm run build` passe

## Tasks / Subtasks

- [x] **Task 1: Créer le système SpriteSheet** (AC: 2)
  - [x] Créer `src/rendering/SpriteSheet.ts`
  - [x] Chargement asynchrone d'une image PNG (`fromImage`) + canvas (`fromCanvas`)
  - [x] Découpage automatique en frames (grille régulière)
  - [x] Méthode `getFrame(index): { sx, sy, sw, sh }` pour accéder à une frame
  - [x] Méthode `drawFrame(ctx, index, x, y, width, height)` pour le rendu

- [x] **Task 2: Créer les sprite sheets** (AC: 1, 4)
  - [x] Créer `src/skins/SpriteGenerator.ts` (génération programmatique Canvas)
  - [x] Idle : 2 frames (personnage debout, léger mouvement respiration)
  - [x] Course : 8 frames (cycle complet avec balancement bras/jambes)
  - [x] Saut : 3 frames (impulsion → lancement → position aérienne)
  - [x] Chute : 2 frames (bras écartés → préparation atterrissage)
  - [x] Atterrissage : 3 frames (impact → recovery → debout)
  - [x] Style : personnage humain avec hoodie orange, jeans, sneakers
  - [x] Taille par frame : 128x128px

- [x] **Task 3: Créer DetailedSkin** (AC: 3, 4, 5)
  - [x] Créer `src/skins/DetailedSkin.ts` implémentant `PlayerSkin`
  - [x] `init()` : générer et charger toutes les sprite sheets
  - [x] `render()` : sélectionner la bonne sprite sheet selon le state
  - [x] Sélection de frame selon l'animation phase
  - [x] Scaling pour respecter les dimensions de jeu (~56x76px rendu)
  - [x] Support du flash collision (tint rouge via globalCompositeOperation)

- [x] **Task 4: Enregistrer DetailedSkin dans le SkinManager** (AC: 3)
  - [x] Enregistrer dans Game.ts lors de l'initialisation
  - [x] Appeler `init()` pour pré-charger les assets
  - [x] Gérer le cas d'erreur de chargement (fallback sur ClassicSkin)

- [x] **Task 5: Tests et Validation** (AC: 6, 7, 8, 9, 10)
  - [x] Tests unitaires SpriteSheet (7 tests: fromCanvas, getFrame, drawFrame, clamping)
  - [x] Tests unitaires DetailedSkin (11 tests: init, render par state, collision, squash)
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (291 tests)
  - [x] `npm run build` passe

## Dev Notes

### Dépendance

- **Requiert Story 6.1** (interface PlayerSkin + SkinManager)

### Approche pour les sprites

Option recommandée : **générer les sprites programmatiquement en Canvas** puis les exporter en PNG. Cela permet :
- Pas de dépendance à un outil externe de pixel art
- Contrôle total des proportions et couleurs
- Possibilité de créer un script de génération (`scripts/generate-sprites.ts`)

Alternative : utiliser un outil comme Aseprite ou Piskel pour du pixel art manuel.

### Design du personnage détaillé

Inspirations pour le style "humain urbain nocturne" :
- **Corps** : proportions humaines (~7-8 têtes de hauteur, compressé pour 64px)
- **Vêtements** : hoodie/veste sombre, jean, sneakers
- **Couleurs** : teintes cohérentes avec la palette ville de nuit (oranges du personnage actuel comme accent)
- **Silhouette** : lisible à petite taille, contraste fort avec le fond sombre

### Structure sprite sheet

```
player-run.png : [F1][F2][F3][F4][F5][F6][F7][F8]
                  ← 64px →
                  Chaque frame = 64x64px
                  Total = 512x64px pour 8 frames
```

### Fichiers à créer

```
src/rendering/SpriteSheet.ts     # Système de chargement/découpage
src/skins/DetailedSkin.ts        # Nouveau skin
public/assets/sprites/            # Dossier des PNG
  player-idle.png
  player-run.png
  player-jump.png
  player-fall.png
  player-land.png
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/rendering/SpriteSheet.test.ts |
| Unit | Vitest | tests/unit/skins/DetailedSkin.test.ts |

### Standards de test
- Mocker `Image` et `drawImage` pour les tests de SpriteSheet
- Vérifier la sélection correcte des frames selon le state/phase
- Test de fallback si image non chargée

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed ESLint globals: added `HTMLImageElement` and `Image` to `eslint.config.js`
- Fixed SpriteSheet constructor: replaced `instanceof HTMLCanvasElement` with explicit `loaded` parameter for testability

### Completion Notes List

- Created `SpriteSheet` class supporting both `fromImage` (async PNG) and `fromCanvas` (programmatic) sources
- Created `SpriteGenerator` that draws a detailed human character using Canvas 2D API:
  - Head with hair, face, eyes
  - Torso with hoodie (orange, matching game palette), pocket detail, collar
  - Arms with sleeves, skin forearm, hands
  - Legs with jeans (dark blue), sneakers with orange accent stripe
  - Full pose system supporting varied limb angles per frame
- Created `DetailedSkin` implementing `PlayerSkin` interface
- Approach: programmatic generation at runtime (no external PNG files needed)
- 18 new tests added (7 SpriteSheet + 11 DetailedSkin), 291 total
- The DetailedSkin uses the run sheet for the idle state (character is always running)
- Sprite frame size: 128x128, rendered at ~56x76px in-game

### File List

| File | Action |
|------|--------|
| `src/rendering/SpriteSheet.ts` | Created — Sprite sheet loader/slicer |
| `src/skins/SpriteGenerator.ts` | Created — Programmatic sprite generation |
| `src/skins/DetailedSkin.ts` | Created — Detailed human skin |
| `src/core/Game.ts` | Modified — Register DetailedSkin |
| `eslint.config.js` | Modified — Added HTMLImageElement, Image globals |
| `tests/unit/rendering/SpriteSheet.test.ts` | Created — 7 tests |
| `tests/unit/skins/DetailedSkin.test.ts` | Created — 11 tests |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
| 2026-02-01 | 1.1 | Implementation complete | Dev Agent (James) |
