# Story 6.3: Animations Fluides et Réalistes

## Status

Ready for Review

## Story

**As a** player,
**I want** smooth and natural character animations,
**so that** the character feels alive and the gameplay is satisfying.

## Acceptance Criteria

1. **Cycle de course** : Animation fluide avec timing adaptatif (s'accélère avec la vitesse du jeu)
2. **Saut - Impulsion** : Frame d'impulsion visible au départ du saut
3. **Saut - Transition montée→chute** : Transition fluide quand vélocité Y passe de négative à positive
4. **Atterrissage** : Séquence flexion → recovery → reprise course (pas de snap)
5. Squash & stretch appliqué sur les sprites (compression à l'atterrissage, étirement au saut)
6. Vitesse du cycle de course proportionnelle à la vitesse de défilement (`SCROLL.SPEED` × difficulté)
7. Tests unitaires pour les transitions d'animation et le timing des frames
8. `npm run lint` passe
9. `npm run test:run` passe
10. `npm run build` passe

## Tasks / Subtasks

- [x] **Task 1: Créer AnimationController** (AC: 1, 5, 6)
  - [x] Créer `src/skins/AnimationController.ts`
  - [x] Gestion du frame index courant avec interpolation temporelle
  - [x] Méthode `update(deltaTime, gameSpeed)` : avancer l'animation
  - [x] Méthode `setState(newState)` : changer d'animation avec transition
  - [x] Vitesse d'animation paramétrable et liée à la vitesse du jeu
  - [x] Support loop (course) et one-shot (atterrissage)

- [x] **Task 2: Implémenter les transitions entre états** (AC: 2, 3, 4)
  - [x] `idle → jumping` : jouer frame d'impulsion avant la montée
  - [x] `jumping → falling` : transition quand velocity.y > 0, changer de sprite sheet
  - [x] `falling → landing` : déclencher l'animation d'atterrissage
  - [x] `landing → idle` : reprendre le cycle de course après recovery
  - [x] Pas de frame "vide" entre les transitions

- [x] **Task 3: Intégrer le squash & stretch sur les sprites** (AC: 5)
  - [x] Appliquer `squashFactor` du Player aux dimensions de rendu du sprite
  - [x] Ancrage au sol (pieds fixes) pendant le squash
  - [x] Étirement léger au début du saut (stretch vertical)
  - [x] Compression à l'atterrissage (squash horizontal)

- [x] **Task 4: Adapter la vitesse d'animation à la difficulté** (AC: 6)
  - [x] Lire la vitesse courante depuis DifficultySystem ou SCROLL.SPEED
  - [x] Calculer le ratio : `animSpeed = baseSpeed * (currentSpeed / baseScrollSpeed)`
  - [x] Appliquer au cycle de course pour que les jambes matchent la vitesse de défilement
  - [x] Les animations de saut/atterrissage ne sont pas affectées par la vitesse

- [x] **Task 5: Mettre à jour DetailedSkin** (AC: 1, 2, 3, 4)
  - [x] Intégrer `AnimationController` dans `DetailedSkin`
  - [x] Passer `gameSpeed` dans les données d'animation
  - [x] Vérifier la fluidité visuelle à différentes vitesses

- [x] **Task 6: Tests et Validation** (AC: 7, 8, 9, 10)
  - [x] Tests AnimationController : transitions, timing, loop vs one-shot
  - [x] Tests : vitesse d'animation proportionnelle à gameSpeed
  - [x] Tests : squash/stretch appliqué correctement
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe
  - [x] `npm run build` passe

## Dev Notes

### Dépendances

- **Requiert Story 6.1** (architecture skins)
- **Requiert Story 6.2** (sprite sheets et DetailedSkin)

### Animation State Machine

```
idle (loop course) ─── jump() ──→ jumping (impulsion → montée)
       ↑                                    │
       │                              vel.y > 0
       │                                    ↓
  landing (flexion → recovery)  ←──── falling (descente)
```

### Timing des frames

| Animation | Frames | Durée totale | Loop |
|-----------|--------|-------------|------|
| Course | 6-8 | ~200ms (base) | Oui |
| Impulsion | 2 | ~100ms | Non |
| Montée | 2-3 | Durée du saut | Non (hold last) |
| Chute | 1-2 | Durée de la chute | Non (hold last) |
| Atterrissage | 2-3 | ~100ms | Non |

### Données d'animation étendues

Le `AnimationData` passé au skin devra inclure :
```typescript
interface AnimationData {
  state: PlayerState;
  runPhase: number;        // existant
  squashFactor: { scaleX: number; scaleY: number }; // existant
  isColliding: boolean;    // existant
  groundY: number;         // existant
  gameSpeed: number;       // NOUVEAU - vitesse courante du jeu
  velocity: { x: number; y: number }; // NOUVEAU - pour transitions
}
```

### Source tree impacté

```
src/skins/
├── AnimationController.ts  # NOUVEAU
├── DetailedSkin.ts         # MODIFIÉ (intégrer AnimationController)
├── PlayerSkin.ts           # POTENTIELLEMENT MODIFIÉ (AnimationData)
├── SkinManager.ts          # Inchangé
└── ClassicSkin.ts          # Inchangé
src/core/Game.ts            # MODIFIÉ (passer gameSpeed)
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/skins/AnimationController.test.ts |
| Unit | Vitest | tests/unit/skins/DetailedSkin.test.ts (update) |

### Standards de test
- Tester les transitions d'état avec des séquences d'update simulées
- Vérifier que la frame correcte est sélectionnée après N updates
- Tester les edge cases : double jump, landing interruption, speed = 0

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- No blocking issues encountered

### Completion Notes List

- Created `AnimationController` with temporal frame interpolation, loop/one-shot modes, and game speed scaling
- AnimationController maps PlayerState → AnimationName (idle→run, jumping→jump, falling→fall, landing→land)
- Run animation speed scales with `gameSpeed` multiplier; jump/fall/land durations are fixed
- Added `deltaTime` and `gameSpeed` fields to `AnimationData` interface
- Game.ts computes speed multiplier from difficulty progression (spawn interval ratio)
- DetailedSkin now delegates all frame selection to AnimationController instead of manual resolveFrame()
- Squash & stretch was already handled by DetailedSkin (squashFactor from Player); confirmed working with sprites
- 24 new AnimationController tests + 3 new DetailedSkin tests = 27 new tests, 318 total

### File List

| File | Action |
|------|--------|
| `src/skins/AnimationController.ts` | Created — Animation state machine with temporal interpolation |
| `src/skins/PlayerSkin.ts` | Modified — Added `deltaTime` and `gameSpeed` to AnimationData |
| `src/skins/DetailedSkin.ts` | Modified — Integrated AnimationController, removed resolveFrame() |
| `src/core/Game.ts` | Modified — Added `lastDeltaTime`, `getCurrentSpeedMultiplier()`, pass new fields to skin |
| `tests/unit/skins/AnimationController.test.ts` | Created — 24 tests |
| `tests/unit/skins/DetailedSkin.test.ts` | Modified — Updated for new AnimationData fields, added 3 tests |
| `tests/unit/skins/ClassicSkin.test.ts` | Modified — Updated for new AnimationData fields |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
| 2026-02-01 | 1.1 | Implementation complete | Dev Agent (James) |
