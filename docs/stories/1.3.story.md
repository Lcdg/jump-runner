# Story 1.3: Player Entity & Basic Jump

## Status

Approved

## Story

**As a** player,
**I want** to see a character on screen that can jump when I press Space,
**so that** I can start interacting with the game.

## Acceptance Criteria

1. Personnage affiché côté gauche de l'écran (forme géométrique simple : rectangle + cercle)
2. Personnage positionné sur une "ligne de sol" visible
3. Appui sur Espace déclenche un saut (le personnage quitte le sol et y revient)
4. Gravité appliquée : le personnage retombe naturellement
5. Le personnage ne peut pas sauter s'il est déjà en l'air (pas de double saut)
6. Tests unitaires pour la physique du saut (vélocité, gravité, position au sol)
7. Test E2E : appuyer sur Espace fait sauter le personnage

## Tasks / Subtasks

- [ ] **Task 1: Create Entity base class** (AC: 1)
  - [ ] Créer `src/entities/Entity.ts`
  - [ ] Implémenter position, velocity, hitbox, active
  - [ ] Méthode abstraite `createHitbox()`
  - [ ] Méthode abstraite `update(deltaTime)`
  - [ ] Getters: `getHitbox()`, `getPosition()`, `isActive()`

- [ ] **Task 2: Create Player entity** (AC: 1, 2)
  - [ ] Créer `src/entities/Player.ts` extends Entity
  - [ ] Ajouter état: `idle`, `jumping`, `falling`
  - [ ] Implémenter `createHitbox()` avec constantes PLAYER
  - [ ] Positionner le joueur à gauche (PLAYER.START_X) sur le sol (groundY)
  - [ ] Méthode `jump()` pour démarrer le saut
  - [ ] Méthode `getState()` pour l'état actuel

- [ ] **Task 3: Implement jump physics** (AC: 3, 4, 5)
  - [ ] Dans `update(deltaTime)`: appliquer gravité si jumping/falling
  - [ ] Appliquer vélocité à la position
  - [ ] Détecter atterrissage (position.y >= groundY)
  - [ ] Méthode `land()` pour reset vélocité et état
  - [ ] Bloquer double saut: `jump()` seulement si state === 'idle'

- [ ] **Task 4: Create InputManager** (AC: 3)
  - [ ] Créer `src/input/InputManager.ts`
  - [ ] Event listeners pour keydown/keyup (Space)
  - [ ] Event listeners pour mousedown/mouseup (clic gauche)
  - [ ] Callback pour `jump_start` et `jump_end`
  - [ ] Prévenir le scroll avec Espace (`preventDefault`)
  - [ ] Flag `isJumpKeyDown` pour éviter répétitions

- [ ] **Task 5: Integrate Player in Game** (AC: 1, 2)
  - [ ] Modifier `Game.ts` pour créer un Player
  - [ ] Ajouter InputManager dans Game
  - [ ] Connecter InputManager.callback à Game.handleInput
  - [ ] Appeler `player.update(deltaTime)` dans Game.update
  - [ ] Rendre le joueur dans Game.render

- [ ] **Task 6: Render Player and Ground** (AC: 1, 2)
  - [ ] Créer méthode `renderPlayer()` dans Game ou Renderer
  - [ ] Dessiner rectangle (corps) + cercle (tête) pour le joueur
  - [ ] Créer méthode `renderGround()` - ligne horizontale visible
  - [ ] Utiliser constantes COLORS pour les couleurs

- [ ] **Task 7: Update constants and types**
  - [ ] Ajouter constantes PLAYER (START_X, WIDTH, HEIGHT, COLOR, etc.)
  - [ ] Ajouter PHYSICS.GRAVITY en pixels/sec² (ex: 1500)
  - [ ] Ajouter PHYSICS.JUMP_VELOCITY en pixels/sec (ex: -600, négatif = vers haut)
  - [ ] Mettre à jour `types.ts` avec InputAction type

- [ ] **Task 8: Write unit tests** (AC: 6)
  - [ ] Créer `tests/unit/entities/Player.test.ts`
  - [ ] Tester `jump()` change l'état de idle à jumping
  - [ ] Tester que le joueur ne peut pas double-sauter
  - [ ] Tester la gravité: vélocité augmente avec deltaTime
  - [ ] Tester l'atterrissage: reset position et état

- [ ] **Task 9: Write E2E test** (AC: 7)
  - [ ] Créer `tests/e2e/player-jump.spec.ts`
  - [ ] Test: appui sur Espace fait bouger le joueur vers le haut
  - [ ] Vérifier que le joueur revient au sol

- [ ] **Task 10: Validation finale**
  - [ ] `npm run lint` passe
  - [ ] `npm run test:run` passe
  - [ ] `npm run test:e2e` passe
  - [ ] Le joueur s'affiche à gauche sur le sol
  - [ ] Appui Espace = saut avec retombée
  - [ ] Pas de double saut possible

## Dev Notes

### Previous Story Context
[Source: Story 1.2 Dev Agent Record]

**Fichiers existants créés dans Story 1.2:**
- `src/core/Game.ts` - Game loop avec update/render
- `src/rendering/Renderer.ts` - Canvas et rendu
- `src/config/constants.ts` - COLORS, DEBUG, CANVAS
- `src/core/types.ts` - Interfaces de base

### Entity Base Class
[Source: architecture/entity-system-standards.md]

```typescript
// src/entities/Entity.ts
export abstract class Entity {
  protected position: Position;
  protected velocity: Velocity;
  protected hitbox: Hitbox;
  protected active: boolean = true;

  constructor(x: number, y: number) {
    this.position = { x, y };
    this.velocity = { x: 0, y: 0 };
    this.hitbox = this.createHitbox();
  }

  protected abstract createHitbox(): Hitbox;
  abstract update(deltaTime: number): void;

  getHitbox(): Hitbox { /* ... */ }
  getPosition(): Position { return { ...this.position }; }
  isActive(): boolean { return this.active; }
}
```

### Player Entity
[Source: architecture/entity-system-standards.md]

```typescript
// src/entities/Player.ts
export type PlayerState = 'idle' | 'jumping' | 'falling';

export class Player extends Entity {
  private state: PlayerState = 'idle';

  jump(): void {
    if (this.state === 'idle') {
      this.velocity.y = PHYSICS.JUMP_VELOCITY;
      this.state = 'jumping';
    }
  }

  update(deltaTime: number): void {
    if (this.state !== 'idle') {
      this.velocity.y += PHYSICS.GRAVITY * deltaTime;
      this.position.y += this.velocity.y * deltaTime;

      if (this.position.y >= groundY) {
        this.land();
      }
    }
  }

  private land(): void {
    this.position.y = groundY;
    this.velocity.y = 0;
    this.state = 'idle';
  }
}
```

### InputManager
[Source: architecture/input-system.md]

```typescript
// src/input/InputManager.ts
export type InputAction = { type: 'jump_start' } | { type: 'jump_end' };

export class InputManager {
  private callback: ((action: InputAction) => void) | null = null;
  private isJumpKeyDown: boolean = false;

  attach(callback: (action: InputAction) => void): void {
    this.callback = callback;
    document.addEventListener('keydown', this.handleKeyDown);
    document.addEventListener('keyup', this.handleKeyUp);
  }

  private handleKeyDown = (event: KeyboardEvent): void => {
    if (event.repeat) return;
    if (event.code === 'Space' && !this.isJumpKeyDown) {
      this.isJumpKeyDown = true;
      this.emit({ type: 'jump_start' });
    }
  };
}
```

### Constants to Add
[Source: architecture/game-configuration-constants.md]

```typescript
// À ajouter dans constants.ts
export const PLAYER = {
  START_X: 100,
  WIDTH: 40,
  HEIGHT: 60,
  HEAD_RADIUS: 15,
  COLOR: '#e94560',
  HITBOX_OFFSET_X: 5,
  HITBOX_OFFSET_Y: 0,
  HITBOX_WIDTH: 30,
  HITBOX_HEIGHT: 60,
} as const;

export const PHYSICS = {
  GRAVITY: 1500,        // pixels/sec² (acceleration)
  JUMP_VELOCITY: -600,  // pixels/sec (negative = up)
} as const;

export const COLORS = {
  // existants...
  GROUND: '#16213e',
  PLAYER: '#e94560',
  PLAYER_HEAD: '#ff6b6b',
} as const;
```

### Project Structure After This Story

```
src/
├── main.ts
├── config/constants.ts      # MODIFIED - PLAYER, PHYSICS constants
├── core/
│   ├── Game.ts              # MODIFIED - Player, InputManager integration
│   └── types.ts             # MODIFIED - InputAction type
├── entities/
│   ├── Entity.ts            # NEW - Base class
│   └── Player.ts            # NEW - Player entity
├── input/
│   └── InputManager.ts      # NEW - Keyboard/mouse handling
└── rendering/
    └── Renderer.ts
```

## Testing

### Test Standards
[Source: architecture/testing-strategy.md]

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/` |
| E2E | Playwright | `tests/e2e/` |

### Unit Tests to Create

**Player.test.ts** (`tests/unit/entities/Player.test.ts`):
```typescript
import { describe, it, expect } from 'vitest';

describe('Player', () => {
  describe('jump()', () => {
    it('should change state from idle to jumping', () => {
      // Test implementation
    });

    it('should not allow double jump', () => {
      // Test: jump() when already jumping should not change velocity
    });

    it('should set negative velocity on jump', () => {
      // velocity.y should be PHYSICS.JUMP_VELOCITY (negative)
    });
  });

  describe('update()', () => {
    it('should apply gravity when jumping', () => {
      // velocity.y should increase by GRAVITY * deltaTime
    });

    it('should land when reaching ground', () => {
      // state should become 'idle', position.y = groundY
    });
  });
});
```

### E2E Test to Create

**player-jump.spec.ts** (`tests/e2e/player-jump.spec.ts`):
```typescript
import { test, expect } from '@playwright/test';

test('player should jump when Space is pressed', async ({ page }) => {
  await page.goto('/');

  // Get initial player position (would need to expose via data attribute or similar)
  // Press Space
  await page.keyboard.press('Space');

  // Wait a bit for jump animation
  await page.waitForTimeout(100);

  // Verify player moved up (implementation depends on how we expose state)
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used
*(À compléter par le Dev Agent)*

### Debug Log References
*(À compléter par le Dev Agent)*

### Completion Notes List
*(À compléter par le Dev Agent)*

### File List
*(À compléter par le Dev Agent)*

---

## QA Results
*(À compléter par le QA Agent)*
