# Story 2.1: Obstacle Spawning & Movement

## Status

Done

## Story

**As a** player,
**I want** obstacles to appear and scroll towards me,
**so that** I have something to avoid and the game has a challenge.

## Acceptance Criteria

1. Obstacles générés à droite de l'écran (hors zone visible)
2. Obstacles défilent de droite à gauche à la même vitesse que le décor
3. Obstacles représentés par des formes géométriques simples (rectangles)
4. Obstacles supprimés de la mémoire une fois sortis à gauche de l'écran
5. Hauteurs d'obstacles variées (petits obstacles = petit saut suffit, grands = grand saut requis)
6. Espacement minimum entre obstacles pour garantir que c'est "jouable"
7. Tests unitaires pour le spawning, le mouvement et la suppression des obstacles
8. Test E2E : vérifier qu'un obstacle traverse l'écran de droite à gauche

## Tasks / Subtasks

- [x] **Task 1: Créer la classe Obstacle** (AC: 3)
  - [x] Créer `src/entities/Obstacle.ts` extends Entity
  - [x] Propriétés: position, velocity, width, height
  - [x] Implémenter `createHitbox()`
  - [x] Implémenter `update(deltaTime)` pour le mouvement

- [x] **Task 2: Ajouter constantes OBSTACLE** (AC: 5, 6)
  - [x] `OBSTACLE.MIN_WIDTH`, `OBSTACLE.MAX_WIDTH`
  - [x] `OBSTACLE.MIN_HEIGHT`, `OBSTACLE.MAX_HEIGHT`
  - [x] `OBSTACLE.MIN_SPAWN_INTERVAL`, `OBSTACLE.MAX_SPAWN_INTERVAL`
  - [x] `OBSTACLE.COLOR`, `OBSTACLE.SPAWN_MARGIN`

- [x] **Task 3: Créer le système de spawning** (AC: 1, 6)
  - [x] Timer pour le spawn avec intervalle aléatoire
  - [x] Créer obstacle à x = screenWidth + margin
  - [x] Dimensions aléatoires dans les limites définies
  - [x] Position y basée sur groundY

- [x] **Task 4: Intégrer dans Game.ts** (AC: 2, 4)
  - [x] Array pour stocker les obstacles actifs
  - [x] Appeler obstacle.update() pour chaque obstacle
  - [x] Supprimer les obstacles inactifs (filter)
  - [x] Rendre les obstacles dans render()

- [x] **Task 5: Écrire tests unitaires** (AC: 7)
  - [x] 12 tests Obstacle: création, mouvement, hitbox, deactivation

- [x] **Task 6: Écrire test E2E** (AC: 8)
  - [x] 3 tests E2E pour obstacles

- [x] **Task 7: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (70 tests)
  - [x] `npm run build` passe

## Dev Notes

### Previous Story Context
[Source: Story 1.5]

**Code existant pertinent:**

1. **Entity.ts** (`src/entities/Entity.ts`):
   - Classe abstraite de base
   - position, velocity, hitbox, active
   - `createHitbox()` abstraite, `update(deltaTime)` abstraite

2. **Game.ts** (`src/core/Game.ts`):
   - Game loop avec update/render
   - Scrolling déjà implémenté (SCROLL.SPEED = 300)
   - Pattern établi pour éléments qui défilent

3. **constants.ts**:
   - SCROLL.SPEED = 300 (vitesse du défilement)

### Approche Technique

**Classe Obstacle:**
```typescript
export class Obstacle extends Entity {
  private width: number;
  private height: number;

  constructor(x: number, groundY: number, width: number, height: number) {
    super(x, groundY - height);
    this.width = width;
    this.height = height;
    this.velocity.x = -SCROLL.SPEED; // Même vitesse que le décor
  }

  update(deltaTime: number): void {
    this.position.x += this.velocity.x * deltaTime;
    if (this.position.x < -this.width) {
      this.active = false; // Marquer pour suppression
    }
  }
}
```

**Spawning dans Game.ts:**
```typescript
private spawnTimer: number = 0;
private nextSpawnTime: number = this.getRandomSpawnTime();
private obstacles: Obstacle[] = [];

private updateObstacles(deltaTime: number): void {
  this.spawnTimer += deltaTime;
  if (this.spawnTimer >= this.nextSpawnTime) {
    this.spawnObstacle();
    this.spawnTimer = 0;
    this.nextSpawnTime = this.getRandomSpawnTime();
  }

  // Update and remove inactive
  this.obstacles = this.obstacles.filter(obs => {
    obs.update(deltaTime);
    return obs.isActive();
  });
}
```

### Constantes Suggérées

```typescript
export const OBSTACLE = {
  MIN_WIDTH: 30,
  MAX_WIDTH: 50,
  MIN_HEIGHT: 40,
  MAX_HEIGHT: 80,
  MIN_SPAWN_INTERVAL: 1.5,  // secondes
  MAX_SPAWN_INTERVAL: 3.0,  // secondes
  COLOR: '#e94560',
} as const;
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/` |
| E2E | Playwright | `tests/e2e/` |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée | PO Agent (Sarah) |
| 2025-01-17 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A

### Completion Notes List
- Classe Obstacle créée avec mouvement automatique vers la gauche
- Spawning avec intervalle aléatoire (1.5-3.0s)
- Dimensions aléatoires (30-50px largeur, 40-90px hauteur)
- Obstacles désactivés automatiquement quand hors écran
- 12 nouveaux tests unitaires
- 3 tests E2E

### File List
**Created:**
- `src/entities/Obstacle.ts` - Classe obstacle
- `tests/unit/entities/Obstacle.test.ts` - 12 tests
- `tests/e2e/obstacles.spec.ts` - 3 tests

**Modified:**
- `src/config/constants.ts` - Constantes OBSTACLE
- `src/core/Game.ts` - Spawning, update, render obstacles

---

## QA Results
*(À compléter par le QA Agent)*
