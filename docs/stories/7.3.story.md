# Story 7.3: Layout Adaptatif (Portrait & Paysage)

## Status

Draft

## Story

**As a** mobile player,
**I want** the game to work in both portrait and landscape orientation,
**so that** I can play however I hold my phone.

## Acceptance Criteria

1. Le canvas s'adapte dynamiquement aux deux orientations sans rechargement
2. Recalcul correct de groundY, position joueur, spawn margin lors du resize/rotation
3. Score, FPS, textes d'overlay lisibles et bien positionnés dans les deux orientations
4. Pas de clignotement ou saut visuel lors de la rotation du téléphone
5. Les obstacles existants sont repositionnés correctement après un resize
6. `npm run lint` passe
7. `npm run test:run` passe
8. `npm run build` passe

## Tasks / Subtasks

- [ ] **Task 1: Améliorer le gestionnaire de resize** (AC: 1, 4)
  - [ ] Dans `Renderer.ts`, écouter aussi `orientationchange` en plus de `resize`
  - [ ] Ajouter un debounce ou `requestAnimationFrame` pour éviter les recalculs multiples
  - [ ] S'assurer que `imageSmoothingEnabled` est re-appliqué après resize (le context se reset)

- [ ] **Task 2: Recalculer les positions après resize** (AC: 2, 5)
  - [ ] Exposer un callback `onResize` dans `Renderer` que `Game` peut écouter
  - [ ] Dans `Game`, recalculer `player.reset(newGroundY)` si le groundY change
  - [ ] Repositionner ou filtrer les obstacles dont la position est hors-écran
  - [ ] Recalculer les crosswalks, buildings, trees pour le nouveau width

- [ ] **Task 3: Adapter l'UI aux deux orientations** (AC: 3)
  - [ ] Vérifier que le score est positionné relativement (padding from right/top)
  - [ ] Vérifier que les overlays (attract, game over) sont centrés dynamiquement
  - [ ] Vérifier que le texte "Press S to change skin" est positionné en bas relatif
  - [ ] Si l'écran est très petit (< 400px height en portrait), réduire la taille des fonts

- [ ] **Task 4: Tests et Validation** (AC: 6, 7, 8)
  - [ ] Tests : resize recalcule groundY correctement
  - [ ] Tests : positions restent cohérentes après resize
  - [ ] `npm run lint` passe
  - [ ] `npm run test:run` passe
  - [ ] `npm run build` passe

## Dev Notes

### Dépendances

- **Requiert Story 7.1** (meta tags viewport pour empêcher le zoom)
- **Requiert Story 7.2** (touch controls doivent fonctionner après rotation)

### Code actuel Renderer

`src/rendering/Renderer.ts` gère déjà :
- `window.addEventListener('resize', () => this.handleResize())`
- `handleResize()` met à jour `this.width`, `this.height`, et resize le canvas
- `getGroundY()` retourne `Math.floor(this.height * CANVAS.GROUND_Y_PERCENT)` — déjà proportionnel

Le resize est donc partiellement géré. Le problème est que `Game.ts` ne re-synchronise pas les entités (player, obstacles) quand le groundY change.

### Points d'attention

- Sur iOS, le resize event peut ne pas se déclencher immédiatement lors de la rotation. `orientationchange` est plus fiable.
- Le canvas context se reset lors du resize (`imageSmoothingEnabled` revient à `true`)
- Ne PAS forcer une orientation — le jeu doit marcher dans les deux

### Source tree impacté

```
src/rendering/Renderer.ts     # MODIFIÉ (orientationchange, callback, debounce)
src/core/Game.ts              # MODIFIÉ (écouter resize, recalculer positions)
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/rendering/Renderer.test.ts (update) |
| Unit | Vitest | tests/unit/core/Game.test.ts (update) |

### Standards de test
- Simuler un changement de dimensions et vérifier que groundY est recalculé
- Vérifier que le player est repositionné correctement

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
