# Story 2.3: Progressive Difficulty

## Status

Done

## Story

**As a** player,
**I want** the game to become harder over time,
**so that** I feel challenged and motivated to improve.

## Acceptance Criteria

1. Fréquence d'apparition des obstacles augmente avec le temps de jeu
2. Difficulté initiale accessible (obstacles espacés, patterns simples)
3. Progression fluide (pas de spike soudain de difficulté)
4. Paramètres de difficulté configurables (vitesse d'augmentation, min/max fréquence)
5. La vitesse de défilement reste constante (seule la fréquence change)
6. Après X temps, la difficulté atteint un plateau (ne devient pas impossible)
7. Tests unitaires pour l'algorithme de progression (vérifier les valeurs à t=0, t=30s, t=60s, etc.)
8. Test d'intégration : jouer 60 secondes et vérifier que la fréquence a augmenté

## Tasks / Subtasks

- [x] **Task 1: Créer le système de difficulté** (AC: 1, 3, 4, 6)
  - [x] Créer `src/systems/DifficultySystem.ts`
  - [x] Implémenter fonction `calculateSpawnInterval(elapsedTime: number): { min: number, max: number }`
  - [x] Utiliser interpolation linéaire entre valeurs initiales et finales
  - [x] Implémenter plateau après `DIFFICULTY.PLATEAU_TIME`

- [x] **Task 2: Ajouter constantes DIFFICULTY** (AC: 2, 4, 6)
  - [x] `DIFFICULTY.INITIAL_MIN_INTERVAL` (valeur initiale facile: 2.0s)
  - [x] `DIFFICULTY.INITIAL_MAX_INTERVAL` (valeur initiale facile: 3.5s)
  - [x] `DIFFICULTY.FINAL_MIN_INTERVAL` (valeur finale difficile: 0.8s)
  - [x] `DIFFICULTY.FINAL_MAX_INTERVAL` (valeur finale difficile: 1.5s)
  - [x] `DIFFICULTY.PLATEAU_TIME` (temps pour atteindre max: 60s)
  - [x] N/A - `DIFFICULTY.RAMP_CURVE` (linear par défaut dans l'algorithme)

- [x] **Task 3: Intégrer dans Game.ts** (AC: 1, 5)
  - [x] Importer `DifficultySystem`
  - [x] Ajouter `gameTime: number` pour tracker le temps de jeu
  - [x] Modifier `getRandomSpawnTime()` pour utiliser `getSpawnTime(gameTime)`
  - [x] Incrémenter `gameTime` dans `update(deltaTime)`
  - [x] `SCROLL.SPEED` reste constant (non modifié)

- [x] **Task 4: Exposer API pour tests et debug** (AC: 7)
  - [x] Ajouter `getGameTime(): number` dans Game.ts
  - [x] Ajouter `getCurrentDifficulty(): SpawnInterval` dans Game.ts

- [x] **Task 5: Écrire tests unitaires DifficultySystem** (AC: 7)
  - [x] Test: t=0s → intervalles initiaux (2.0-3.5s)
  - [x] Test: t=30s → intervalles intermédiaires
  - [x] Test: t=60s → intervalles finaux (0.8-1.5s)
  - [x] Test: t=120s → toujours intervalles finaux (plateau)
  - [x] Test: progression monotone (jamais plus facile)
  - [x] Test: valeurs toujours positives

- [x] **Task 6: Écrire tests intégration Game** (AC: 8)
  - [x] Test: gameTime s'incrémente correctement
  - [x] Test: spawn interval diminue avec le temps
  - [x] Test: SCROLL.SPEED reste constant

- [x] **Task 7: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (123 tests)
  - [x] `npm run build` passe
  - [x] Test manuel: jouer 60s et observer augmentation fréquence

## Dev Notes

### Previous Story Context
[Source: Story 2.2]

**Code existant pertinent:**

1. **Game.ts** (`src/core/Game.ts:49-54`):
```typescript
private getRandomSpawnTime(): number {
  return (
    OBSTACLE.MIN_SPAWN_INTERVAL +
    Math.random() * (OBSTACLE.MAX_SPAWN_INTERVAL - OBSTACLE.MIN_SPAWN_INTERVAL)
  );
}
```

2. **constants.ts** (`src/config/constants.ts:55-64`):
```typescript
export const OBSTACLE = {
  MIN_SPAWN_INTERVAL: 1.5,
  MAX_SPAWN_INTERVAL: 3.0,
  // ...
} as const;
```

### Architecture Technique

**Algorithme de progression linéaire:**
```typescript
function calculateSpawnInterval(elapsedTime: number): { min: number, max: number } {
  const progress = Math.min(elapsedTime / DIFFICULTY.PLATEAU_TIME, 1);

  const min = DIFFICULTY.INITIAL_MIN_INTERVAL +
    (DIFFICULTY.FINAL_MIN_INTERVAL - DIFFICULTY.INITIAL_MIN_INTERVAL) * progress;
  const max = DIFFICULTY.INITIAL_MAX_INTERVAL +
    (DIFFICULTY.FINAL_MAX_INTERVAL - DIFFICULTY.INITIAL_MAX_INTERVAL) * progress;

  return { min, max };
}
```

**Structure DifficultySystem** [Source: architecture/coding-standards.md]:
- Naming: `DifficultySystem` (PascalCase + "System")
- Systems stateless: fonction pure, pas d'état interne
- Fichier: `src/systems/DifficultySystem.ts`

### File Locations

| Nouveau fichier | Location |
|-----------------|----------|
| DifficultySystem | `src/systems/DifficultySystem.ts` |
| Tests unitaires | `tests/unit/systems/DifficultySystem.test.ts` |

| Fichier à modifier | Modifications |
|--------------------|---------------|
| `src/core/Game.ts` | gameTime, getRandomSpawnTime(), getCurrentDifficulty() |
| `src/config/constants.ts` | DIFFICULTY constants |

### Valeurs suggérées

| Paramètre | Valeur initiale | Valeur finale | Unité |
|-----------|-----------------|---------------|-------|
| MIN_INTERVAL | 2.0 | 0.8 | secondes |
| MAX_INTERVAL | 3.5 | 1.5 | secondes |
| PLATEAU_TIME | 60 | - | secondes |

### Technical Constraints

- **Stateless**: DifficultySystem ne stocke pas l'état, reçoit elapsedTime en paramètre
- **Monotone**: La difficulté ne doit jamais diminuer
- **Bounded**: Les intervalles ne doivent jamais être <= 0

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/systems/DifficultySystem.test.ts` |
| Integration | Vitest | `tests/unit/core/Game.difficulty.test.ts` |

**Couverture attendue**: 90%+ pour DifficultySystem (pure logic)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 1.0 | Story créée | Dev Agent (James) |
| 2026-01-17 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A

### Completion Notes List
- DifficultySystem créé avec interpolation linéaire
- Constantes DIFFICULTY configurables dans constants.ts
- gameTime tracké dans Game.ts pour progression
- getSpawnTime() utilise la difficulté dynamique
- API exposée: getGameTime(), getCurrentDifficulty()
- 16 tests unitaires DifficultySystem
- 8 tests intégration Game.difficulty
- Plateau à 60 secondes, spawn interval passe de 2.0-3.5s à 0.8-1.5s

### File List
**Created:**
- `src/systems/DifficultySystem.ts` - Calcul de difficulté
- `tests/unit/systems/DifficultySystem.test.ts` - 16 tests
- `tests/unit/core/Game.difficulty.test.ts` - 8 tests

**Modified:**
- `src/core/Game.ts` - gameTime, getRandomSpawnTime(), getters
- `src/config/constants.ts` - DIFFICULTY constants

---

## QA Results
*(À compléter par le QA Agent)*
