# Story 2.2: Collision Detection

## Status

Done

## Story

**As a** player,
**I want** the game to detect when I hit an obstacle,
**so that** my mistakes have consequences.

## Acceptance Criteria

1. Hitbox définie pour le personnage (rectangle englobant simplifié)
2. Hitbox définie pour chaque obstacle
3. Collision détectée quand les hitboxes se chevauchent (AABB collision)
4. Collision déclenchée uniquement quand le personnage touche l'obstacle (pas avant, pas après)
5. Événement "collision" émis pour être consommé par le système de game state (Epic 3)
6. Pour l'instant : collision = console.log ou indicateur visuel temporaire (flash rouge)
7. Tests unitaires exhaustifs pour la collision (cas limites : au-dessus, en-dessous, devant, derrière, chevauchement partiel)
8. Test E2E : vérifier qu'une collision est détectée quand le joueur ne saute pas

## Tasks / Subtasks

- [x] **Task 1: Créer le système de collision AABB** (AC: 3, 4)
  - [x] Créer `src/systems/CollisionSystem.ts`
  - [x] Implémenter fonction `checkAABBCollision(hitboxA: Hitbox, hitboxB: Hitbox): boolean`
  - [x] Vérifier chevauchement sur les 4 axes (gauche, droite, haut, bas)
  - [x] Retourner `true` uniquement si chevauchement réel (pas adjacent)

- [x] **Task 2: Créer le système d'événements collision** (AC: 5)
  - [x] Ajouter type `CollisionEvent` dans `src/core/types.ts`
  - [x] Ajouter callback optionnel `onCollision` dans `Game.ts`
  - [x] Émettre l'événement avec les entités impliquées (player, obstacle)

- [x] **Task 3: Intégrer la détection dans Game.ts** (AC: 3, 4, 5)
  - [x] Importer `CollisionSystem`
  - [x] Dans `update()`, après `updateObstacles()`, appeler `checkCollisions()`
  - [x] Boucler sur tous les obstacles actifs
  - [x] Comparer hitbox du player avec hitbox de chaque obstacle
  - [x] Si collision détectée, émettre l'événement

- [x] **Task 4: Implémenter l'indicateur visuel temporaire** (AC: 6)
  - [x] Ajouter état `isColliding: boolean` dans `Game.ts`
  - [x] Ajouter timer `collisionFlashTimer: number`
  - [x] Si collision: activer flash rouge pendant 200ms
  - [x] Modifier `renderPlayer()` pour afficher en rouge si `isColliding`
  - [x] Ajouter `console.log('Collision detected!')` pour debug

- [x] **Task 5: Écrire tests unitaires CollisionSystem** (AC: 7)
  - [x] Test: pas de collision - obstacle à droite du player
  - [x] Test: pas de collision - obstacle à gauche du player
  - [x] Test: pas de collision - obstacle au-dessus du player
  - [x] Test: pas de collision - obstacle en-dessous du player
  - [x] Test: collision - chevauchement complet
  - [x] Test: collision - chevauchement partiel coin supérieur gauche
  - [x] Test: collision - chevauchement partiel coin supérieur droit
  - [x] Test: collision - chevauchement partiel coin inférieur gauche
  - [x] Test: collision - chevauchement partiel coin inférieur droit
  - [x] Test: pas de collision - hitboxes adjacentes (bord à bord)
  - [x] Test: collision - 1 pixel de chevauchement

- [x] **Task 6: Écrire tests unitaires intégration Game** (AC: 3, 4)
  - [x] Test: collision détectée quand player et obstacle se chevauchent
  - [x] Test: pas de collision quand player saute par-dessus
  - [x] Test: callback onCollision appelé lors d'une collision
  - [x] Test: flash rouge activé lors d'une collision

- [x] **Task 7: Écrire test E2E** (AC: 8)
  - [x] Test: lancer le jeu sans input, attendre collision avec premier obstacle
  - [x] Vérifier indicateur visuel (flash rouge ou log console)

- [x] **Task 8: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (99 tests)
  - [x] `npm run build` passe
  - [x] Test manuel: jouer et vérifier collision visuellement

## Dev Notes

### Previous Story Context
[Source: Story 2.1]

**Éléments déjà implémentés:**
- `Entity.getHitbox()` retourne la hitbox en coordonnées monde (position + offset)
- `Player.createHitbox()` utilise `PLAYER.HITBOX_*` constants
- `Obstacle.createHitbox()` retourne hitbox = dimensions complètes (x:0, y:0)
- `Game.getPlayer()` et `Game.getObstacles()` exposent les entités

**Hitbox Player** (`src/entities/Player.ts:24-30`):
```typescript
protected createHitbox(): Hitbox {
  return {
    x: PLAYER.HITBOX_OFFSET_X,
    y: PLAYER.HITBOX_OFFSET_Y,
    width: PLAYER.HITBOX_WIDTH,
    height: PLAYER.HITBOX_HEIGHT,
  };
}
```

**Hitbox Obstacle** (`src/entities/Obstacle.ts:23-29`):
```typescript
protected createHitbox(): Hitbox {
  return {
    x: 0,
    y: 0,
    width: this.width || 0,
    height: this.height || 0,
  };
}
```

### Architecture Technique

**Algorithme AABB** [Source: architecture/tech-stack.md]:
```typescript
function checkAABBCollision(a: Hitbox, b: Hitbox): boolean {
  return (
    a.x < b.x + b.width &&
    a.x + a.width > b.x &&
    a.y < b.y + b.height &&
    a.y + a.height > b.y
  );
}
```

**Structure CollisionSystem** [Source: architecture/coding-standards.md]:
- Naming: `CollisionSystem` (PascalCase + "System")
- Systems stateless: fonction pure, pas d'état interne
- Fichier: `src/systems/CollisionSystem.ts`

### File Locations
[Source: architecture/coding-standards.md, Story 2.1]

| Nouveau fichier | Location |
|-----------------|----------|
| CollisionSystem | `src/systems/CollisionSystem.ts` |
| Tests unitaires | `tests/unit/systems/CollisionSystem.test.ts` |
| Tests E2E | `tests/e2e/collision.spec.ts` |

| Fichier à modifier | Modifications |
|--------------------|---------------|
| `src/core/Game.ts` | Import CollisionSystem, checkCollisions(), flash visuel |
| `src/core/types.ts` | Ajouter CollisionEvent type |

### Technical Constraints

- **Frame-independent**: La détection doit être appelée à chaque frame, pas liée au deltaTime
- **No GC spikes**: Ne pas créer de nouveaux objets à chaque frame dans la boucle de collision
- **Type everything**: Pas de `any`, types explicites pour CollisionEvent

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/systems/CollisionSystem.test.ts` |
| Integration | Vitest | `tests/unit/core/Game.collision.test.ts` |
| E2E | Playwright | `tests/e2e/collision.spec.ts` |

**Couverture attendue**: 90%+ pour CollisionSystem (pure logic)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée via create-next-story | BMad Orchestrator |
| 2026-01-17 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A

### Completion Notes List
- CollisionSystem créé avec algorithme AABB stateless
- Types CollisionEvent et CollisionCallback ajoutés
- Détection de collision intégrée dans Game.update()
- Flash rouge (200ms) lors des collisions
- Console.log pour debug des collisions
- API exposée: setOnCollision(), getIsColliding()
- Constante COLLISION ajoutée dans constants.ts
- 14 tests unitaires CollisionSystem (tous les cas limites)
- 9 tests unitaires intégration Game.collision
- 3 tests E2E collision

### File List
**Created:**
- `src/systems/CollisionSystem.ts` - Système de collision AABB
- `tests/unit/systems/CollisionSystem.test.ts` - 14 tests
- `tests/unit/core/Game.collision.test.ts` - 9 tests
- `tests/e2e/collision.spec.ts` - 3 tests

**Modified:**
- `src/core/types.ts` - CollisionEvent, CollisionCallback
- `src/core/Game.ts` - checkCollisions(), flash visuel, callbacks
- `src/config/constants.ts` - COLLISION constants

---

## QA Results
*(À compléter par le QA Agent)*
