# Story 1.5: Scrolling Background

## Status

Ready for Review

## Story

**As a** player,
**I want** to see the environment scrolling from right to left,
**so that** I feel like my character is running forward.

## Acceptance Criteria

1. Ligne de sol qui défile de droite à gauche à vitesse constante
2. Éléments de décor simples (lignes ou formes) qui défilent pour renforcer la sensation de mouvement
3. Le défilement est continu et seamless (pas de "saut" visible)
4. Vitesse de défilement constante (paramétrable pour les futurs ajustements)
5. Le personnage reste à sa position fixe horizontale pendant le défilement
6. Tests unitaires pour la logique de défilement et le repositionnement des éléments
7. Performance : maintien des 60 FPS avec le décor qui défile

## Tasks / Subtasks

- [x] **Task 1: Ajouter constantes pour le scrolling** (AC: 4)
  - [x] `SCROLL.SPEED`: vitesse de défilement (300 pixels/seconde)
  - [x] `SCROLL.GROUND_MARK_WIDTH`: largeur des marques au sol (3px)
  - [x] `SCROLL.GROUND_MARK_GAP`: espacement entre marques (60px)
  - [x] `SCROLL.DECORATION_COUNT`: nombre d'éléments de décor (10)

- [x] **Task 2: Créer le système de scrolling du sol** (AC: 1, 3)
  - [x] Créer des marques au sol qui se répètent
  - [x] Déplacer les marques vers la gauche à chaque frame
  - [x] Recycler les marques sorties à gauche vers la droite
  - [x] Transition seamless entre les marques

- [x] **Task 3: Ajouter des éléments de décor** (AC: 2, 3)
  - [x] Créer des rectangles simples dans le fond (tailles aléatoires)
  - [x] Faire défiler les éléments de décor à la même vitesse que le sol
  - [x] Recycler les éléments de décor quand ils sortent de l'écran

- [x] **Task 4: Intégrer le scrolling dans Game.ts** (AC: 5)
  - [x] Appeler `updateScrolling(deltaTime)` dans `update()`
  - [x] Rendre les décorations et marques au sol dans `render()`
  - [x] Le joueur reste à sa position fixe

- [x] **Task 5: Écrire tests unitaires** (AC: 6)
  - [x] 9 tests pour le scrolling (mouvement, recyclage, frame-independence)

- [x] **Task 6: Écrire test E2E** (AC: 7)
  - [x] 3 tests E2E pour vérifier stabilité et performance

- [x] **Task 7: Validation finale**
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (58 tests)
  - [ ] Test manuel à effectuer

## Dev Notes

### Previous Story Context
[Source: Story 1.4]

**Code existant pertinent:**

1. **Game.ts** (`src/core/Game.ts`):
   - Game loop avec update/render
   - `renderGround()` dessine actuellement une ligne de sol statique
   - FPS tracking existant

2. **Renderer.ts** (`src/rendering/Renderer.ts`):
   - Méthodes getWidth(), getHeight(), getGroundY()
   - Canvas rendering

3. **constants.ts** (`src/config/constants.ts`):
   - Constantes existantes: CANVAS, COLORS, PHYSICS

### Approche Technique Recommandée

**Option A - Segments de sol recyclés (recommandée):**
```typescript
// Créer plusieurs segments de sol
interface GroundSegment {
  x: number;
  width: number;
}

// Dans update: déplacer tous les segments
segments.forEach(seg => {
  seg.x -= SCROLL.SPEED * deltaTime;
  if (seg.x + seg.width < 0) {
    // Recycler à droite
    seg.x = maxX + SCROLL.GROUND_SEGMENT_WIDTH;
  }
});
```

**Éléments de décor (parallax léger):**
```typescript
interface Decoration {
  x: number;
  y: number;
  type: 'line' | 'dot' | 'rectangle';
}

// Déplacer à la même vitesse que le sol
decorations.forEach(deco => {
  deco.x -= SCROLL.SPEED * deltaTime;
  if (deco.x < -50) {
    // Recycler à droite avec position aléatoire
    deco.x = width + Math.random() * 100;
    deco.y = randomInRange(groundY - 200, groundY - 50);
  }
});
```

### Constantes Suggérées

```typescript
export const SCROLL = {
  SPEED: 300,              // pixels/seconde
  GROUND_LINE_GAP: 50,     // Espacement entre les marques au sol
  DECORATION_COUNT: 8,     // Nombre d'éléments de décor
} as const;
```

### Structure des Fichiers

```
src/
├── config/constants.ts      # MODIFIED - constantes SCROLL
├── core/Game.ts             # MODIFIED - logique scrolling dans update/render
└── (optionnel) systems/ScrollingSystem.ts  # Si on veut extraire la logique
```

## Testing

### Test Standards

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | `tests/unit/` |
| E2E | Playwright | `tests/e2e/` |

### Unit Tests

**Scrolling tests:**
```typescript
describe('Scrolling', () => {
  it('should move ground segments left based on deltaTime', () => {
    // segment.x -= SPEED * deltaTime
  });

  it('should recycle segments that exit screen left', () => {
    // segment goes to right side when x + width < 0
  });

  it('should maintain seamless loop', () => {
    // No gaps between segments
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story créée | PO Agent (Sarah) |
| 2025-01-17 | 1.1 | Implémentation complète | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A

### Completion Notes List
- Système de scrolling avec marques au sol et décorations
- Marques au sol recyclées seamless vers la droite
- Décorations avec tailles/positions aléatoires, opacité 0.3
- Mouvement frame-independent avec deltaTime
- 9 nouveaux tests unitaires pour le scrolling
- 3 tests E2E pour la stabilité

### File List
**Modified:**
- `src/config/constants.ts` - Ajout constantes SCROLL
- `src/core/types.ts` - Ajout interfaces GroundMark, Decoration
- `src/core/Game.ts` - Logique scrolling (init, update, render)

**Created:**
- `tests/unit/core/Scrolling.test.ts` - 9 tests unitaires
- `tests/e2e/scrolling.spec.ts` - 3 tests E2E

---

## QA Results
*(À compléter par le QA Agent)*
