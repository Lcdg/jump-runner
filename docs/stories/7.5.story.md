# Story 7.5: Optimisations Performance Mobile

## Status

Draft

## Story

**As a** mobile player,
**I want** the game to run smoothly on my phone,
**so that** the gameplay is enjoyable without lag or stutter.

## Acceptance Criteria

1. Détection de FPS bas (< 50) et réduction automatique des effets visuels coûteux
2. Optimisations canvas : context hint `desynchronized`, CSS `will-change: transform`
3. Réduction de la fréquence des calculs non-critiques quand le FPS est bas
4. 60 FPS maintenu sur mobile récent (iPhone 12+, Android 2021+)
5. Pas de memory leaks sur sessions longues (vérification obstacle/building recycling)
6. `npm run lint` passe
7. `npm run test:run` passe
8. `npm run build` passe

## Tasks / Subtasks

- [ ] **Task 1: Ajouter les optimisations canvas** (AC: 2)
  - [ ] Dans `Renderer.ts`, créer le context avec `{ desynchronized: true, alpha: false }`
  - [ ] Ajouter `will-change: transform` au CSS du canvas dans `index.html`
  - [ ] S'assurer que `imageSmoothingEnabled = false` est maintenu

- [ ] **Task 2: Créer un système de qualité adaptative** (AC: 1, 3)
  - [ ] Créer `src/systems/PerformanceMonitor.ts`
  - [ ] Tracker le FPS moyen sur les 30 dernières frames
  - [ ] Si FPS moyen < 50 pendant 2 secondes → passer en mode "low quality"
  - [ ] Si FPS moyen > 55 pendant 5 secondes → revenir en mode "high quality"
  - [ ] Exposer `isLowQuality(): boolean`

- [ ] **Task 3: Réduire les effets en mode low quality** (AC: 1, 3)
  - [ ] Désactiver les halos de lampadaires (`globalAlpha` + arc) en low quality
  - [ ] Désactiver les ombres de texte (`shadowBlur`, `shadowColor`) en low quality
  - [ ] Réduire le nombre de fenêtres d'immeubles rendues (1 sur 2) en low quality
  - [ ] Passer le flag `isLowQuality` aux fonctions de rendu concernées

- [ ] **Task 4: Vérifier le memory management** (AC: 5)
  - [ ] Vérifier que les obstacles hors-écran sont bien recyclés (déjà le cas via `isActive()`)
  - [ ] Vérifier que les buildings sont recyclés et non recréés (déjà le cas)
  - [ ] S'assurer qu'aucun event listener n'est accumulé (pas de fuite sur resize/touch)

- [ ] **Task 5: Tests et Validation** (AC: 6, 7, 8)
  - [ ] Tests unitaires PerformanceMonitor : transition low/high quality
  - [ ] Tests unitaires : FPS tracking et seuils
  - [ ] `npm run lint` passe
  - [ ] `npm run test:run` passe
  - [ ] `npm run build` passe

## Dev Notes

### Dépendances

- **Requiert Stories 7.1-7.4** (toute l'infrastructure mobile en place)

### Effets coûteux identifiés

1. **Halos lampadaires** : `globalAlpha = 0.3` + `ctx.arc()` + `ctx.fill()` — dans `renderStreetlight()`
2. **Glow shop signs** : `globalAlpha = 0.4` + `fillRect` — dans `renderShopSign()`
3. **Text shadows** : `shadowBlur`, `shadowColor`, `shadowOffset` — dans tous les overlays
4. **Fenêtres immeubles** : boucle sur `building.windows` × nombre de buildings — dans `renderBuildings()`
5. **Trees opacity** : `globalAlpha = 0.7/0.6` — dans `renderTrees()`

### Context hints

```typescript
// desynchronized: true — réduit la latence de rendu, idéal pour les jeux
// alpha: false — le canvas n'a pas besoin de transparence (fond opaque)
canvas.getContext('2d', { desynchronized: true, alpha: false });
```

### Source tree impacté

```
src/systems/PerformanceMonitor.ts  # NOUVEAU
src/rendering/Renderer.ts          # MODIFIÉ (context hints)
src/core/Game.ts                   # MODIFIÉ (intégrer PerformanceMonitor, passer isLowQuality)
index.html                         # MODIFIÉ (will-change CSS)
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/systems/PerformanceMonitor.test.ts |

### Standards de test
- Simuler des séquences de FPS pour vérifier les transitions low/high quality
- Tester les seuils et la temporisation (2s pour descendre, 5s pour remonter)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
