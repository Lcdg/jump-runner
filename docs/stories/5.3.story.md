# Story 5.3: Validation des Patterns (Garantir Passage)

## Status

Done

## Story

**As a** player,
**I want** to always have a way to pass obstacles,
**so that** the game is challenging but fair.

## Acceptance Criteria

1. Ne jamais spawner obstacle sol + aérien au même moment
2. Gap minimum entre obstacle sol et aérien consécutifs
3. Après obstacle aérien, délai pour que le joueur retombe
4. Configuration des contraintes dans constants.ts
5. Tests unitaires : vérifier qu'aucun pattern impossible n'est généré
6. `npm run lint` passe
7. `npm run test:run` passe
8. `npm run build` passe

## Tasks / Subtasks

- [x] **Task 1: Ajouter constantes SPAWN_RULES** (AC: 4)
  - [x] MIN_GROUND_TO_AERIAL_GAP (150px)
  - [x] MIN_AERIAL_TO_GROUND_GAP (200px)
  - [x] MIN_SAME_CATEGORY_GAP (100px)

- [x] **Task 2: Tracker dernier obstacle** (AC: 1, 2, 3)
  - [x] lastSpawnedCategory: 'ground' | 'aerial' | null
  - [x] lastSpawnedX: number

- [x] **Task 3: Implémenter validation** (AC: 1, 2, 3)
  - [x] Vérifier gap avant spawn
  - [x] Forcer catégorie si gap insuffisant
  - [x] Méthode getValidObstacleType()

- [x] **Task 4: Tests et Validation** (AC: 5, 6, 7, 8)
  - [x] Tests unitaires pattern validation (16 tests)
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe (249 tests)
  - [x] `npm run build` passe

## Dev Notes

### Spawn Rules

```typescript
const SPAWN_RULES = {
  // Après obstacle sol, gap minimum avant aérien
  MIN_GROUND_TO_AERIAL_GAP: 150,

  // Après obstacle aérien, gap minimum avant sol
  // (temps pour retomber)
  MIN_AERIAL_TO_GROUND_GAP: 200,

  // Gap minimum entre mêmes catégories
  MIN_SAME_CATEGORY_GAP: 100,
};
```

### Validation Logic

```typescript
function getValidObstacleType(): ObstacleType {
  const candidateType = getRandomObstacleType();
  const candidateCategory = OBSTACLE_TYPES[candidateType].category;

  // Calculer la distance depuis le dernier obstacle
  const gap = screenWidth - lastObstacleX;

  // Vérifier si le pattern est valide
  if (lastCategory === 'ground' && candidateCategory === 'aerial') {
    if (gap < MIN_GROUND_TO_AERIAL_GAP) {
      // Forcer un obstacle sol
      return getRandomGroundType();
    }
  }

  if (lastCategory === 'aerial' && candidateCategory === 'ground') {
    if (gap < MIN_AERIAL_TO_GROUND_GAP) {
      // Forcer un obstacle aérien
      return getRandomAerialType();
    }
  }

  return candidateType;
}
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/core/Game.spawn.test.ts |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-19 | 1.0 | Story créée | Dev Agent |
