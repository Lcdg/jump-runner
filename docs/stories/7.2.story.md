# Story 7.2: Contrôles Tactiles

## Status

Draft

## Story

**As a** mobile player,
**I want** to control my character by tapping the screen,
**so that** I can play the game without a keyboard.

## Acceptance Criteria

1. Touch start = saut (équivalent Space/click)
2. Touch hold = saut plus haut (maintien du doigt = hold jump)
3. Touch end = relâcher le saut
4. Multi-touch ignoré (seul le premier doigt compte)
5. Coexistence tactile + clavier/souris (desktop non cassé)
6. Pas de conflit entre touch et mouse events (pas de double-fire sur appareils hybrides)
7. Tests unitaires pour les touch handlers
8. `npm run lint` passe
9. `npm run test:run` passe
10. `npm run build` passe

## Tasks / Subtasks

- [ ] **Task 1: Ajouter les touch event listeners** (AC: 1, 2, 3, 4)
  - [ ] Dans `InputManager`, ajouter `touchstart` → émet `jump_start`
  - [ ] `touchend` / `touchcancel` → émet `jump_end`
  - [ ] Utiliser `event.changedTouches[0]` pour identifier le premier doigt
  - [ ] Tracker le touch ID pour ignorer les doigts supplémentaires
  - [ ] `event.preventDefault()` sur les touch events pour éviter le scroll

- [ ] **Task 2: Éviter le double-fire touch/mouse** (AC: 6)
  - [ ] Utiliser `isTouchDevice()` de `src/utils/platform.ts` (Story 7.1)
  - [ ] Si touch device : ne pas attacher les mouse event listeners
  - [ ] Ou : utiliser un flag `touchActive` pour ignorer les mouse events synthétiques

- [ ] **Task 3: Vérifier la coexistence desktop** (AC: 5)
  - [ ] S'assurer que les event listeners clavier ne sont pas affectés
  - [ ] Tester sur desktop que Space, Click, et Touch (si disponible) fonctionnent
  - [ ] Les touch events sont `{ passive: false }` pour pouvoir appeler `preventDefault()`

- [ ] **Task 4: Tests et Validation** (AC: 7, 8, 9, 10)
  - [ ] Tests unitaires : touchstart émet jump_start
  - [ ] Tests unitaires : touchend émet jump_end
  - [ ] Tests unitaires : multi-touch ignoré
  - [ ] `npm run lint` passe
  - [ ] `npm run test:run` passe
  - [ ] `npm run build` passe

## Dev Notes

### Dépendances

- **Requiert Story 7.1** (platform.ts avec `isTouchDevice()`, meta tags + `touch-action: none`)

### Code actuel InputManager

Le fichier `src/input/InputManager.ts` gère déjà :
- `keydown` / `keyup` (Space → jump, S/Escape → skin selector, flèches)
- `mousedown` / `mouseup` (click → jump)
- Un flag `isJumpKeyDown` pour le tracking

Il faut ajouter `touchstart` / `touchend` / `touchcancel` avec la même logique que les mouse events, en trackant le touch identifier pour le multi-touch.

### Touch Events API

```typescript
// touchstart
event.changedTouches[0].identifier  // ID du doigt
event.preventDefault()               // Empêcher scroll et mouse émulé

// touchend / touchcancel
event.changedTouches[0].identifier  // Vérifier que c'est le même doigt
```

### Double-fire problème

Sur certains appareils hybrides (laptops tactiles), le navigateur émet des mouse events synthétiques après les touch events. Solutions :
1. Ne pas attacher les mouse listeners si `isTouchDevice()` est true
2. Ou utiliser un flag temporaire après touchstart pour ignorer le mousedown suivant

### Source tree impacté

```
src/input/InputManager.ts     # MODIFIÉ (touch events)
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/input/InputManager.test.ts (update) |

### Standards de test
- Créer des `TouchEvent` mockés avec `changedTouches`
- Tester l'émission correcte des actions sur touch
- Vérifier que le multi-touch est ignoré

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
