# Story 7.2: Contrôles Tactiles

## Status

Ready for Review

## Story

**As a** mobile player,
**I want** to control my character by tapping the screen,
**so that** I can play the game without a keyboard.

## Acceptance Criteria

1. Touch start = saut (équivalent Space/click)
2. Touch hold = saut plus haut (maintien du doigt = hold jump)
3. Touch end = relâcher le saut
4. Multi-touch ignoré (seul le premier doigt compte)
5. Coexistence tactile + clavier/souris (desktop non cassé)
6. Pas de conflit entre touch et mouse events (pas de double-fire sur appareils hybrides)
7. Tests unitaires pour les touch handlers
8. `npm run lint` passe
9. `npm run test:run` passe
10. `npm run build` passe

## Tasks / Subtasks

- [x] **Task 1: Ajouter les touch event listeners** (AC: 1, 2, 3, 4)
  - [x] Dans `InputManager`, ajouter `touchstart` → émet `jump_start`
  - [x] `touchend` / `touchcancel` → émet `jump_end`
  - [x] Utiliser `event.changedTouches[0]` pour identifier le premier doigt
  - [x] Tracker le touch ID pour ignorer les doigts supplémentaires
  - [x] `event.preventDefault()` sur les touch events pour éviter le scroll

- [x] **Task 2: Éviter le double-fire touch/mouse** (AC: 6)
  - [x] Utiliser `isTouchDevice()` de `src/utils/platform.ts` (Story 7.1)
  - [x] Si touch device : ne pas attacher les mouse event listeners
  - [x] Ou : utiliser un flag `touchActive` pour ignorer les mouse events synthétiques

- [x] **Task 3: Vérifier la coexistence desktop** (AC: 5)
  - [x] S'assurer que les event listeners clavier ne sont pas affectés
  - [x] Tester sur desktop que Space, Click, et Touch (si disponible) fonctionnent
  - [x] Les touch events sont `{ passive: false }` pour pouvoir appeler `preventDefault()`

- [x] **Task 4: Tests et Validation** (AC: 7, 8, 9, 10)
  - [x] Tests unitaires : touchstart émet jump_start
  - [x] Tests unitaires : touchend émet jump_end
  - [x] Tests unitaires : multi-touch ignoré
  - [x] `npm run lint` passe
  - [x] `npm run test:run` passe
  - [x] `npm run build` passe

## Dev Notes

### Dépendances

- **Requiert Story 7.1** (platform.ts avec `isTouchDevice()`, meta tags + `touch-action: none`)

### Code actuel InputManager

Le fichier `src/input/InputManager.ts` gère déjà :
- `keydown` / `keyup` (Space → jump, S/Escape → skin selector, flèches)
- `mousedown` / `mouseup` (click → jump)
- Un flag `isJumpKeyDown` pour le tracking

Il faut ajouter `touchstart` / `touchend` / `touchcancel` avec la même logique que les mouse events, en trackant le touch identifier pour le multi-touch.

### Touch Events API

```typescript
// touchstart
event.changedTouches[0].identifier  // ID du doigt
event.preventDefault()               // Empêcher scroll et mouse émulé

// touchend / touchcancel
event.changedTouches[0].identifier  // Vérifier que c'est le même doigt
```

### Double-fire problème

Sur certains appareils hybrides (laptops tactiles), le navigateur émet des mouse events synthétiques après les touch events. Solutions :
1. Ne pas attacher les mouse listeners si `isTouchDevice()` est true
2. Ou utiliser un flag temporaire après touchstart pour ignorer le mousedown suivant

### Source tree impacté

```
src/input/InputManager.ts     # MODIFIÉ (touch events)
```

## Testing

| Type | Framework | Location |
|------|-----------|----------|
| Unit | Vitest | tests/unit/input/InputManager.test.ts (update) |

### Standards de test
- Créer des `TouchEvent` mockés avec `changedTouches`
- Tester l'émission correcte des actions sur touch
- Vérifier que le multi-touch est ignoré

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Touch events (touchstart/touchend/touchcancel) added to InputManager with touch ID tracking for multi-touch rejection
- Double-fire prevention: on touch devices, mouse listeners are not attached (using `isTouchDevice()` from platform.ts)
- Keyboard listeners always attached for coexistence desktop/mobile
- Touch events use `{ passive: false }` to allow `preventDefault()` (prevents scroll/zoom)
- `activeTouchId` tracks the first finger; additional touches are ignored
- `touchActive` flag and `isTouchActive()` getter added for future use
- Added `TouchEvent` and `Touch` to ESLint globals config
- 7 new tests added (344 total, all passing)

### File List
| File | Action |
|------|--------|
| src/input/InputManager.ts | Modified |
| tests/unit/input/InputManager.test.ts | Modified |
| eslint.config.js | Modified |

### Debug Log References
None

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-01 | 1.0 | Story créée | PO Agent (Sarah) |
| 2026-02-02 | 1.1 | Implémentation complète - touch events, tests, validation | Dev Agent (James) |
